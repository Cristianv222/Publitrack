{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Gestión de Órdenes - PubliTrack{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stats-card h3 {
        font-size: 2rem;
        margin: 0;
        color: #333;
    }

    .stats-card p {
        margin: 5px 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }

    .badge-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .badge-pendiente {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-validado {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-en_produccion {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .badge-completado {
        background-color: #cce7ff;
        color: #004085;
    }

    .badge-no_validado {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-cancelado {
        background-color: #f8d7da;
        color: #721c24;
    }

    .badge-prioridad {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    .badge-urgente {
        background-color: #dc3545;
        color: white;
    }

    .badge-alta {
        background-color: #ffc107;
        color: #000;
    }

    .badge-normal {
        background-color: #17a2b8;
        color: white;
    }

    .badge-baja {
        background-color: #28a745;
        color: white;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .btn-action {
        padding: 5px 8px;
        font-size: 0.8rem;
        margin: 1px;
    }

    .btn-action-completar {
        padding: 6px 12px;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .order-number {
        font-weight: 600;
        color: #2c5aa0;
    }

    .btn-descargar {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: white;
    }

    .btn-descargar:hover {
        background-color: #138496;
        border-color: #117a8b;
    }

    .btn-subir {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
    }

    .btn-subir:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }

    .estado-info {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-shopping-cart me-2"></i>Gestión de Órdenes de Toma
            </h2>
            <p class="text-muted mb-0">Administra las órdenes de toma del sistema</p>
        </div>
        {% if user.es_admin or user.es_vendedor %}
        <button class="btn btn-primary" onclick="abrirModalCrear()">
            <i class="fas fa-plus me-2"></i>Nueva Orden
        </button>
        {% endif %}
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-primary">{{ total_ordenes }}</h3>
                <p>Total de Órdenes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-warning">{{ ordenes_pendientes }}</h3>
                <p>Pendientes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-info">{{ ordenes_validadas }}</h3>
                <p>Validadas</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-success">{{ ordenes_completadas }}</h3>
                <p>Completadas</p>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <input type="text" name="search" class="form-control"
                        placeholder="Buscar por código, cliente, RUC..." value="{{ search }}">
                </div>
                <div class="col-md-3">
                    <select name="estado" class="form-select">
                        <option value="">Todos los estados</option>
                        <option value="pendiente" {% if estado_filter == "pendiente" %}selected{% endif %}>Pendiente
                        </option>
                        <option value="validado" {% if estado_filter == "validado" %}selected{% endif %}>Validado</option>
                        <option value="en_produccion" {% if estado_filter == "en_produccion" %}selected{% endif %}>En
                            Producción</option>
                        <option value="completado" {% if estado_filter == "completado" %}selected{% endif %}>Completado
                        </option>
                        <option value="no_validado" {% if estado_filter == "no_validado" %}selected{% endif %}>No Validado
                        </option>
                        <option value="cancelado" {% if estado_filter == "cancelado" %}selected{% endif %}>Cancelado
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="prioridad" class="form-select">
                        <option value="">Todas las prioridades</option>
                        <option value="urgente" {% if prioridad_filter == "urgente" %}selected{% endif %}>Urgente</option>
                        <option value="alta" {% if prioridad_filter == "alta" %}selected{% endif %}>Alta</option>
                        <option value="normal" {% if prioridad_filter == "normal" %}selected{% endif %}>Normal</option>
                        <option value="baja" {% if prioridad_filter == "baja" %}selected{% endif %}>Baja</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Detalle</th>
                            <th>Total</th>
                            <th>Prioridad</th>
                            <th>Estado</th>
                            <th>Acción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for orden in ordenes %}
                        <tr>
                            <td>
                                <span class="order-number">{{ orden.codigo }}</span>
                                {% if orden.ordenes_generadas.exists %}
                                <br>
                                <small class="estado-info">
                                    <i class="fas fa-file-pdf text-danger"></i>
                                    PDF Generado
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ orden.nombre_cliente }}</strong>
                                {% if orden.ruc_dni_cliente %}
                                <br><small class="text-muted">{{ orden.ruc_dni_cliente }}</small>
                                {% endif %}
                            </td>
                            <td>{{ orden.fecha_orden|date:"d/m/Y H:i" }}</td>
                            <td>
                                <small>
                                    {% if orden.detalle_productos %}
                                    {{ orden.detalle_productos|truncatewords:5 }}
                                    {% else %}
                                    <span class="text-muted">Sin detalles</span>
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <strong>S/ {{ orden.total|floatformat:2 }}</strong>
                            </td>
                            <td>
                                <span class="badge-prioridad badge-{{ orden.prioridad }}">
                                    {{ orden.get_prioridad_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge-status badge-{{ orden.estado }}">
                                    {{ orden.get_estado_display }}
                                </span>
                                {% if orden.estado == 'no_validado' %}
                                <br>
                                <small class="estado-info mt-1">
                                    <i class="fas fa-clock text-warning"></i>
                                    Esperando validación
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                {% if orden.estado == 'pendiente' %}
                                <button class="btn btn-sm btn-success btn-action-completar"
                                    onclick="completarToma({{ orden.id }})" title="Completar Toma">
                                    <i class="fas fa-check-circle me-1"></i>Completar Toma
                                </button>
                                {% elif orden.estado == 'validado' %}
                                <span class="text-muted">Validado </span>
                                {% elif orden.estado == 'no_validado' %}
                                <span class="text-muted">Esperando validación</span>
                                {% elif orden.estado == 'en_produccion' %}
                                <span class="text-muted">En producción</span>
                                {% elif orden.estado == 'completado' %}
                                <span class="text-muted">Completado</span>
                                {% elif orden.estado == 'cancelado' %}
                                <span class="text-muted">Cancelado</span>
                                {% else %}
                                <span class="text-muted">Finalizada</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-info btn-action" onclick="verDetalleOrden({{ orden.id }})"
                                        title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>

                                    {% with ultima_generada=orden.ordenes_generadas.first %}
                                    <button class="btn btn-descargar btn-action"
                                        onclick="abrirModalDescargaOrden({{ orden.id }}, '{{ orden.codigo|escapejs }}', {% if orden.tiene_archivo_validado %}true{% else %}false{% endif %}, {% if ultima_generada %}{{ ultima_generada.id }}{% else %}null{% endif %})"
                                        title="Descargar PDF">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    {% endwith %}

                                    {% if orden.estado != 'cancelado' %}
                                    <button class="btn btn-subir btn-action"
                                        onclick="subirOrdenValidada({{ orden.id }}, '{{ orden.codigo|escapejs }}')"
                                        title="Subir Orden Validada">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    {% endif %}

                                    {% if user.es_admin or user.es_vendedor %}
                                    <button class="btn btn-warning btn-action" onclick="editarOrden({{ orden.id }})"
                                        title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% endif %}

                                    {% if user.es_admin %}
                                    <button class="btn btn-danger btn-action"
                                        onclick="eliminarOrden({{ orden.id }}, '{{ orden.codigo|escapejs }}')"
                                        title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No se encontraron órdenes</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if ordenes.has_other_pages %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if ordenes.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ ordenes.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if estado_filter %}&estado={{ estado_filter }}{% endif %}{% if prioridad_filter %}&prioridad={{ prioridad_filter }}{% endif %}">
                            Anterior
                        </a>
                    </li>
                    {% endif %}

                    {% for num in ordenes.paginator.page_range %}
                    <li class="page-item {% if ordenes.number == num %}active{% endif %}">
                        <a class="page-link"
                            href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if estado_filter %}&estado={{ estado_filter }}{% endif %}{% if prioridad_filter %}&prioridad={{ prioridad_filter }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                    {% endfor %}

                    {% if ordenes.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                            href="?page={{ ordenes.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if estado_filter %}&estado={{ estado_filter }}{% endif %}{% if prioridad_filter %}&prioridad={{ prioridad_filter }}{% endif %}">
                            Siguiente
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>

</div>

<div class="modal fade" id="modalSubirOrden" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Subir Orden Validada</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formSubirOrden" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="subir_orden_id" name="orden_id">

                    <div class="mb-3">
                        <label class="form-label">Seleccionar archivo PDF firmado:</label>
                        <input type="file" class="form-control" id="archivo_orden" name="archivo" accept=".pdf"
                            required>
                        <small class="text-muted">Solo se permiten archivos PDF (máx. 10MB)</small>
                    </div>

                    <div class="alert alert-warning">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Sube el PDF de la orden ya validada y firmada por el cliente.
                            Esto cambiará el estado de la orden a "Validado".
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="subirOrdenValidadaConfirmar()">
                    <i class="fas fa-upload me-2"></i>Subir Orden Validada
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalOrden" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalOrdenTitulo">Nueva Orden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formOrden">
                    {% csrf_token %}
                    <input type="hidden" id="orden_id" name="orden_id">

                    <h6 class="mb-3 text-primary">Información de la Orden</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Cliente <span class="text-danger">*</span></label>
                            <select class="form-select" name="cliente_id" id="cliente_id" required>
                                <option value="">Seleccionar cliente...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" data-nombre="{{ cliente.get_full_name }}"
                                    data-ruc="{{ cliente.ruc_dni }}" data-empresa="{{ cliente.empresa }}"
                                    data-ciudad="{{ cliente.ciudad }}" data-direccion="{{ cliente.direccion_exacta }}"
                                    data-telefono="{{ cliente.telefono }}" data-email="{{ cliente.email }}">
                                    {{ cliente.empresa|default:cliente.get_full_name }} - {{ cliente.ruc_dni }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Prioridad <span class="text-danger">*</span></label>
                            <select class="form-select" name="prioridad" id="prioridad" required>
                                <option value="baja">Baja</option>
                                <option value="normal" selected>Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>

                    <h6 class="mb-3 text-primary">Detalles de Productos/Servicios</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label class="form-label">Descripción <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="detalle_productos" id="detalle_productos" rows="3"
                                required placeholder="Describa los productos o servicios solicitados..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cantidad</label>
                            <input type="number" class="form-control" name="cantidad" id="cantidad" value="1" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total (S/) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="total" id="total" step="0.01" value="0.00"
                                required>
                        </div>
                    </div>

                    <h6 class="mb-3 text-primary">Requerimientos de Producción</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="incluye_tomas" name="incluye_tomas">
                                <label class="form-check-label" for="incluye_tomas">Tomas</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="incluye_audio" name="incluye_audio">
                                <label class="form-check-label" for="incluye_audio">Audio</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="incluye_logo" name="incluye_logo">
                                <label class="form-check-label" for="incluye_logo">Logo</label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-3 text-primary">Información Adicional</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label class="form-label">Estado</label>
                            <select class="form-select" name="estado" id="estado">
                                <option value="pendiente" selected>Pendiente</option>
                                <option value="validado">Validado</option>
                                <option value="en_produccion">En Producción</option>
                                <option value="completado">Completado</option>
                                <option value="no_validado">No Validado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" name="observaciones" id="observaciones" rows="2"
                                placeholder="Observaciones adicionales..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarOrden()">
                    <i class="fas fa-save me-2"></i>Guardar Orden
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalleOrden" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles de la Orden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalleOrdenContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalOpcionesDescarga" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>Descargar Orden
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <h6 class="text-muted mb-1">Seleccione una opción para la orden:</h6>
                    <h4 id="descargaOrdenCodigo" class="fw-bold text-primary"></h4>
                </div>

                <div class="d-grid gap-3">
                    <button class="btn btn-outline-primary btn-lg p-3 text-start d-flex align-items-center"
                        onclick="procederDescargaSistema()">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="fas fa-file-contract fa-2x text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Versión del Sistema</div>
                            <small class="text-muted">Generada automáticamente a partir de los datos</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                    </button>

                    <button id="btnDescargaValidada"
                        class="btn btn-outline-success btn-lg p-3 text-start d-flex align-items-center"
                        onclick="procederDescargaValidado()">
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="fas fa-file-signature fa-2x text-success"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Versión Validada</div>
                            <small class="text-muted">Documento firmado subido por el usuario</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                    </button>

                    <div id="msgNoValidada" class="text-center text-muted small mt-2" style="display:none;">
                        <i class="fas fa-info-circle me-1"></i> No hay versión validada disponible
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar plantilla -->
<div class="modal fade" id="modalSeleccionarPlantilla" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Seleccionar Plantilla
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <h6 class="text-muted mb-1">Seleccione una plantilla para la orden:</h6>
                    <h5 id="plantillaOrdenCodigo" class="fw-bold text-primary"></h5>
                </div>

                <div class="mb-4">
                    <label for="plantillaOrden" class="form-label">Plantilla:</label>
                    <select class="form-select" id="plantillaOrden">
                        <option value="">Cargando plantillas...</option>
                    </select>
                    <small class="text-muted">
                        Seleccione la plantilla que desea utilizar para generar el PDF
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="generarOrdenConPlantilla()">
                    <i class="fas fa-file-pdf me-2"></i>Generar PDF
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let modalOrden;
    let modalDetalleOrden;
    let modalSubirOrden;
    let modalOpcionesDescarga;
    let modalSeleccionarPlantilla; // Nuevo modal
    let ordenDescargaActual = null;
    let ordenGeneradaActualId = null;

    document.addEventListener('DOMContentLoaded', function () {
        modalOrden = new bootstrap.Modal(document.getElementById('modalOrden'));
        modalDetalleOrden = new bootstrap.Modal(document.getElementById('modalDetalleOrden'));
        modalSubirOrden = new bootstrap.Modal(document.getElementById('modalSubirOrden'));
        modalOpcionesDescarga = new bootstrap.Modal(document.getElementById('modalOpcionesDescarga'));
        modalSeleccionarPlantilla = new bootstrap.Modal(document.getElementById('modalSeleccionarPlantilla'));
    });

    function abrirModalCrear() {
        document.getElementById('modalOrdenTitulo').textContent = 'Nueva Orden';
        document.getElementById('formOrden').reset();
        document.getElementById('orden_id').value = '';
        document.getElementById('prioridad').value = 'normal';
        document.getElementById('estado').value = 'pendiente';
        modalOrden.show();
    }

    function editarOrden(ordenId) {
        document.getElementById('modalOrdenTitulo').textContent = 'Editar Orden';
        document.getElementById('orden_id').value = ordenId;

        fetch(`/panel/orders/${ordenId}/detalle/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const orden = data.orden;
                    document.getElementById('cliente_id').value = orden.cliente_id || '';
                    document.getElementById('prioridad').value = orden.prioridad;
                    document.getElementById('detalle_productos').value = orden.detalle_productos || '';
                    document.getElementById('cantidad').value = orden.cantidad || 1;
                    document.getElementById('total').value = orden.total;
                    document.getElementById('estado').value = orden.estado;
                    document.getElementById('observaciones').value = orden.observaciones || '';

                    document.getElementById('incluye_tomas').checked = orden.incluye_tomas || false;
                    document.getElementById('incluye_audio').checked = orden.incluye_audio || false;
                    document.getElementById('incluye_logo').checked = orden.incluye_logo || false;

                    modalOrden.show();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Error al cargar los datos',
                        confirmButtonColor: '#3085d6'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al cargar los datos de la orden',
                    confirmButtonColor: '#3085d6'
                });
            });
    }

    function guardarOrden() {
        const ordenId = document.getElementById('orden_id').value;
        const form = document.getElementById('formOrden');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = {
            cliente_id: document.getElementById('cliente_id').value,
            detalle_productos: document.getElementById('detalle_productos').value,
            cantidad: document.getElementById('cantidad').value,
            total: document.getElementById('total').value,
            prioridad: document.getElementById('prioridad').value,
            estado: document.getElementById('estado').value,
            observaciones: document.getElementById('observaciones').value,
            incluye_tomas: document.getElementById('incluye_tomas').checked,
            incluye_audio: document.getElementById('incluye_audio').checked,
            incluye_logo: document.getElementById('incluye_logo').checked,
        };

        modalOrden.hide();

        Swal.fire({
            title: ordenId ? 'Actualizando...' : 'Guardando...',
            html: `
            <div class="text-center py-3">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Guardando...</span>
                </div>
                <p class="text-muted mb-0">Por favor espere un momento</p>
            </div>
        `,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        const url = ordenId
            ? `/panel/orders/${ordenId}/editar/`
            : '/panel/orders/crear/';

        const method = ordenId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: data.message,
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Error al guardar la orden',
                        confirmButtonColor: '#dc3545'
                    });
                    modalOrden.show();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error de conexión al guardar',
                    confirmButtonColor: '#dc3545'
                });
                modalOrden.show();
            });
    }

    function completarToma(ordenId) {
        fetch(`/panel/orders/${ordenId}/detalle/`)
            .then(response => response.json())
            .then(ordenData => {
                if (ordenData.success) {
                    const orden = ordenData.orden;

                    if (orden.estado !== 'pendiente') {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Acción no permitida',
                            text: `No se puede completar una orden en estado "${orden.estado}". Solo se pueden completar órdenes en estado "Pendiente".`,
                            confirmButtonColor: '#3085d6'
                        });
                        return;
                    }

                    fetch('/panel/plantillas-orden/api/')
                        .then(response => response.json())
                        .then(plantillasData => {
                            if (!plantillasData.success || !plantillasData.plantillas || plantillasData.plantillas.length === 0) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'No hay plantillas disponibles. Contacte al administrador.',
                                    confirmButtonColor: '#3085d6'
                                });
                                return;
                            }

                            return fetch(`/panel/orders/${ordenId}/detalle/`)
                                .then(response => response.json())
                                .then(ordenData => {
                                    if (ordenData.success) {
                                        const orden = ordenData.orden;

                                        let plantillasOptions = '';
                                        plantillasData.plantillas.forEach(plantilla => {
                                            plantillasOptions += `
                                            <option value="${plantilla.id}" ${plantilla.is_default ? 'selected' : ''}>
                                                ${plantilla.nombre} (${plantilla.tipo_orden_display}) - v${plantilla.version}
                                                ${plantilla.is_default ? ' ★' : ''}
                                            </option>
                                        `;
                                        });

                                        const modalHtml = `
                                        <div class="modal fade" id="modalCompletarToma" tabindex="-1">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Completar Toma - ${orden.codigo}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form id="formCompletarToma">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="orden_id" value="${ordenId}">
                                                            
                                                            <h6 class="mb-3 text-primary">Seleccionar Plantilla</h6>
                                                            <div class="row g-3 mb-4">
                                                                <div class="col-12">
                                                                    <label class="form-label">Plantilla para la orden <span class="text-danger">*</span></label>
                                                                    <select class="form-select" name="plantilla_id" id="plantilla_id" required>
                                                                        <option value="">Seleccionar plantilla...</option>
                                                                        ${plantillasOptions}
                                                                    </select>
                                                                    <small class="text-muted">Selecciona la plantilla que se usará para generar el PDF de la orden</small>
                                                                </div>
                                                            </div>
                                                            
                                                            <h6 class="mb-3 text-primary">Información de la Producción</h6>
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Proyecto/Campaña <span class="text-danger">*</span></label>
                                                                    <input type="text" class="form-control" name="proyecto_campania" required
                                                                           value="${orden.proyecto_campania || ''}" placeholder="Nombre del proyecto o campaña">
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Título del Material <span class="text-danger">*</span></label>
                                                                    <input type="text" class="form-control" name="titulo_material" required
                                                                           value="${orden.titulo_material || ''}" placeholder="Título del material a producir">
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-12">
                                                                    <label class="form-label">Descripción Breve <span class="text-danger">*</span></label>
                                                                    <textarea class="form-control" name="descripcion_breve" rows="2" required placeholder="Descripción breve del trabajo a realizar">${orden.descripcion_breve || ''}</textarea>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-12">
                                                                    <label class="form-label">Locaciones <span class="text-danger">*</span></label>
                                                                    <input type="text" class="form-control" name="locaciones" required
                                                                           value="${orden.locaciones || ''}" placeholder="Locaciones donde se realizará la toma">
                                                                </div>
                                                            </div>
                                                            
                                                            <h6 class="mb-3 text-primary">Fechas y Horarios</h6>
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Fecha Inicio Producción <span class="text-danger">*</span></label>
                                                                    <input type="date" class="form-control" name="fecha_produccion_inicio" required
                                                                           value="${orden.fecha_produccion_inicio || ''}">
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Fecha Fin Producción <span class="text-danger">*</span></label>
                                                                    <input type="date" class="form-control" name="fecha_produccion_fin" required
                                                                           value="${orden.fecha_produccion_fin || ''}">
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Hora Inicio <span class="text-danger">*</span></label>
                                                                    <input type="time" class="form-control" name="hora_inicio" required
                                                                           value="${orden.hora_inicio || ''}">
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Hora Fin <span class="text-danger">*</span></label>
                                                                    <input type="time" class="form-control" name="hora_fin" required
                                                                           value="${orden.hora_fin || ''}">
                                                                </div>
                                                            </div>
                                                            
                                                            <h6 class="mb-3 text-primary">Recursos y Equipos</h6>
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-12">
                                                                    <label class="form-label">Equipo Asignado <span class="text-danger">*</span></label>
                                                                    <input type="text" class="form-control" name="equipo_asignado" required
                                                                           value="${orden.equipo_asignado || ''}" placeholder="Equipo técnico asignado">
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-12">
                                                                    <label class="form-label">Recursos Necesarios</label>
                                                                    <textarea class="form-control" name="recursos_necesarios" rows="2" placeholder="Recursos adicionales necesarios">${orden.recursos_necesarios || ''}</textarea>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row g-3 mb-3">
                                                                <div class="col-md-12">
                                                                    <label class="form-label">Observaciones de Completado</label>
                                                                    <textarea class="form-control" name="observaciones_completado" rows="2" placeholder="Observaciones al completar la toma">${orden.observaciones_completado || ''}</textarea>
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                            <i class="fas fa-times me-2"></i>Cancelar
                                                        </button>
                                                        <button type="button" class="btn btn-success" onclick="guardarCompletarToma()">
                                                            <i class="fas fa-check-circle me-2"></i>Completar Toma y Generar PDF
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;

                                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                                        const modal = new bootstrap.Modal(document.getElementById('modalCompletarToma'));
                                        modal.show();

                                        document.getElementById('modalCompletarToma').addEventListener('hidden.bs.modal', function () {
                                            this.remove();
                                        });

                                    } else {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: ordenData.error || 'Error al cargar los datos',
                                            confirmButtonColor: '#3085d6'
                                        });
                                    }
                                });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Error al cargar los datos',
                                confirmButtonColor: '#3085d6'
                            });
                        });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: ordenData.error || 'Error al cargar los datos',
                        confirmButtonColor: '#3085d6'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al cargar los datos',
                    confirmButtonColor: '#3085d6'
                });
            });
    }

    function guardarCompletarToma() {
        const form = document.getElementById('formCompletarToma');
        const ordenId = form.orden_id.value;
        const plantillaId = document.getElementById('plantilla_id').value;

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        if (!plantillaId) {
            Swal.fire({
                icon: 'warning',
                title: 'Plantilla requerida',
                text: 'Por favor selecciona una plantilla',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        const formData = new FormData(form);
        const data = {
            estado: 'no_validado',
            plantilla_id: plantillaId,
            proyecto_campania: formData.get('proyecto_campania'),
            titulo_material: formData.get('titulo_material'),
            descripcion_breve: formData.get('descripcion_breve'),
            locaciones: formData.get('locaciones'),
            fecha_produccion_inicio: formData.get('fecha_produccion_inicio'),
            fecha_produccion_fin: formData.get('fecha_produccion_fin'),
            hora_inicio: formData.get('hora_inicio'),
            hora_fin: formData.get('hora_fin'),
            equipo_asignado: formData.get('equipo_asignado'),
            recursos_necesarios: formData.get('recursos_necesarios'),
            observaciones_completado: formData.get('observaciones_completado')
        };

        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCompletarToma'));
        modal.hide();

        Swal.fire({
            title: 'Completando toma...',
            html: `
            <div class="text-center py-3">
                <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Completando...</span>
                </div>
                <p class="text-muted mb-0">Guardando información y generando PDF...</p>
            </div>
        `,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        fetch(`/panel/orders/${ordenId}/editar/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(updateData => {
                if (updateData.success) {
                    return fetch(`/panel/orders/${ordenId}/generar/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            plantilla_id: plantillaId
                        })
                    });
                } else {
                    throw new Error(updateData.error || 'Error al guardar la información');
                }
            })
            .then(response => response.json())
            .then(pdfData => {
                if (pdfData.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Toma Completada!',
                        html: `
                    <p>La información de producción se guardó correctamente y el PDF fue generado.</p>
                    <p class="text-muted">Estado: <strong>No Validado</strong> - Esperando firma del cliente</p>
                    ${pdfData.archivo_url ?
                                `<a href="${pdfData.archivo_url}" target="_blank" class="btn btn-success mt-2">
                            <i class="fas fa-download me-2"></i>Descargar PDF
                        </a>` :
                                ''
                            }
                `,
                        confirmButtonColor: '#28a745',
                        showCancelButton: true,
                        cancelButtonText: 'Cerrar',
                        confirmButtonText: 'Ver Orden'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.reload();
                        } else {
                            window.location.reload();
                        }
                    });
                } else {
                    throw new Error(pdfData.error || 'Error al generar el PDF');
                }
            })
            .catch(error => {
                console.error('❌ Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Error al completar la toma',
                    confirmButtonColor: '#dc3545'
                });
            });
    }

    function verDetalleOrden(ordenId) {
        const loadingHtml = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
        document.getElementById('detalleOrdenContent').innerHTML = loadingHtml;
        modalDetalleOrden.show();

        fetch(`/panel/orders/${ordenId}/detalle/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const orden = data.orden;

                    let camposAdicionales = '';

                    if (orden.estado === 'no_validado' || orden.estado === 'validado' || orden.estado === 'completado') {
                        camposAdicionales = `
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3 border-bottom pb-2">Información de Producción</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Proyecto/Campaña:</strong><br>
                                ${orden.proyecto_campania || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Título del Material:</strong><br>
                                ${orden.titulo_material || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Descripción Breve:</strong><br>
                                ${orden.descripcion_breve || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Locaciones:</strong><br>
                                ${orden.locaciones || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Fecha Inicio Producción:</strong><br>
                                ${orden.fecha_produccion_inicio || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Fecha Fin Producción:</strong><br>
                                ${orden.fecha_produccion_fin || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Hora Inicio:</strong><br>
                                ${orden.hora_inicio || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Hora Fin:</strong><br>
                                ${orden.hora_fin || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Equipo Asignado:</strong><br>
                                ${orden.equipo_asignado || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Recursos Necesarios:</strong><br>
                                ${orden.recursos_necesarios || '<span class="text-muted">No definido</span>'}
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Observaciones de Completado:</strong><br>
                                ${orden.observaciones_completado || '<span class="text-muted">Ninguna</span>'}
                            </div>
                        </div>
                    `;
                    }

                    const html = `
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6 class="text-primary border-bottom pb-2">Información Básica</h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Código:</strong><br>
                            <span class="order-number badge bg-primary">${orden.codigo}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Fecha de Orden:</strong><br>
                            ${orden.fecha_orden}
                        </div>
                        
                        <div class="col-12 mb-4 mt-2">
                            <h6 class="text-primary border-bottom pb-2">Información del Cliente</h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Nombre:</strong><br>
                            ${orden.nombre_cliente || '<span class="text-muted">N/A</span>'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>RUC/DNI:</strong><br>
                            ${orden.ruc_dni_cliente || '<span class="text-muted">N/A</span>'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Empresa:</strong><br>
                            ${orden.empresa_cliente || '<span class="text-muted">N/A</span>'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Ciudad:</strong><br>
                            ${orden.ciudad_cliente || '<span class="text-muted">N/A</span>'}
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Dirección:</strong><br>
                            ${orden.direccion_cliente || '<span class="text-muted">N/A</span>'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Teléfono:</strong><br>
                            ${orden.telefono_cliente || '<span class="text-muted">N/A</span>'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Email:</strong><br>
                            ${orden.email_cliente || '<span class="text-muted">N/A</span>'}
                        </div>
                        
                        <div class="col-12 mb-4 mt-2">
                            <h6 class="text-primary border-bottom pb-2">Detalles de la Orden</h6>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Productos/Servicios:</strong><br>
                            ${orden.detalle_productos || '<span class="text-muted">Sin detalles</span>'}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Cantidad:</strong><br>
                            ${orden.cantidad || 1}
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Total:</strong><br>
                            <strong class="text-success">S/ ${orden.total}</strong>
                        </div>
                        
                        <div class="col-12 mb-4 mt-2">
                            <h6 class="text-primary border-bottom pb-2">Estado y Prioridad</h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Prioridad:</strong><br>
                            <span class="badge-prioridad badge-${orden.prioridad}">${orden.prioridad}</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Estado:</strong><br>
                            <span class="badge-status badge-${orden.estado}">${orden.estado}</span>
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Vendedor Asignado:</strong><br>
                            ${orden.vendedor ? `<span class="fw-bold text-dark">${orden.vendedor}</span>` : '<span class="text-muted fst-italic">Sin vendedor asignado</span>'}
                        </div>
                        <div class="col-12 mb-3">
                            <strong>Observaciones:</strong><br>
                            ${orden.observaciones || '<span class="text-muted">Ninguna</span>'}
                        </div>
                        
                        ${camposAdicionales}
                    </div>
                `;
                    document.getElementById('detalleOrdenContent').innerHTML = html;
                } else {
                    document.getElementById('detalleOrdenContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${data.error || 'Error al cargar detalles'}
                    </div>
                `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('detalleOrdenContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error al cargar los detalles de la orden
                </div>
            `;
            });
    }

    function eliminarOrden(ordenId, codigoOrden) {
        Swal.fire({
            title: '¿Eliminar orden?',
            html: `
            <div class="text-center mb-3">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <p class="mb-2">¿Estás seguro de eliminar la orden:</p>
                <h5 class="text-primary mb-2">${codigoOrden}</h5>
                <small class="text-muted d-block">
                    <i class="fas fa-info-circle me-1"></i>
                    Esta acción no se puede deshacer
                </small>
            </div>
        `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '<i class="fas fa-trash me-2"></i>Sí, eliminar',
            cancelButtonText: '<i class="fas fa-times me-2"></i>Cancelar',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Eliminando...',
                    html: `
                    <div class="text-center py-3">
                        <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Eliminando...</span>
                        </div>
                        <p class="text-muted mb-0">Por favor espere un momento</p>
                    </div>
                `,
                    allowOutsideClick: false,
                    showConfirmButton: false
                });

                fetch(`/panel/orders/${ordenId}/eliminar/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Eliminado!',
                                text: data.message,
                                confirmButtonColor: '#28a745'
                            }).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Error al eliminar',
                                confirmButtonColor: '#dc3545'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error de conexión al eliminar',
                            confirmButtonColor: '#dc3545'
                        });
                    });
            }
        });
    }

    function descargarOrden(ordenId) {
        console.log("🔍 Intentando descargar orden ID:", ordenId);

        Swal.fire({
            title: 'Buscando PDF...',
            html: `
            <div class="text-center py-3">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Buscando...</span>
                </div>
                <p class="text-muted mb-0">Buscando archivo PDF generado...</p>
            </div>
        `,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        fetch(`/panel/orders/${ordenId}/detalle/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("✅ Datos de orden cargados:", data.orden);

                    if (data.orden.ordenes_generadas && data.orden.ordenes_generadas.length > 0) {
                        const ultimaOrden = data.orden.ordenes_generadas[0];
                        if (ultimaOrden.archivo_orden_pdf) {
                            window.open(ultimaOrden.archivo_orden_pdf, '_blank');
                            Swal.close();
                        } else {
                            throw new Error('La orden generada no tiene archivo PDF');
                        }
                    } else {
                        throw new Error('No se encontraron órdenes generadas para esta orden');
                    }
                } else {
                    throw new Error('No se pudo cargar la orden');
                }
            })
            .catch(error => {
                console.error('❌ Error al descargar:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo descargar el PDF',
                    confirmButtonColor: '#dc3545'
                });
            });
    }

    function subirOrdenValidada(ordenId, codigoOrden) {
        document.getElementById('subir_orden_id').value = ordenId;

        document.getElementById('formSubirOrden').reset();

        document.querySelector('#modalSubirOrden .modal-title').textContent =
            `Subir Orden Validada - ${codigoOrden}`;

        modalSubirOrden.show();
    }
    function subirOrdenValidadaConfirmar() {
        const form = document.getElementById('formSubirOrden');
        const ordenId = document.getElementById('subir_orden_id').value;
        const archivo = document.getElementById('archivo_orden').files[0];

        if (!archivo) {
            Swal.fire({
                icon: 'warning',
                title: 'Archivo requerido',
                text: 'Por favor selecciona un archivo PDF',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        if (!archivo.name.toLowerCase().endsWith('.pdf')) {
            Swal.fire({
                icon: 'error',
                title: 'Formato incorrecto',
                text: 'Solo se permiten archivos PDF',
                confirmButtonColor: '#dc3545'
            });
            return;
        }

        if (archivo.size > 10 * 1024 * 1024) {
            Swal.fire({
                icon: 'error',
                title: 'Archivo muy grande',
                text: 'El archivo no debe superar los 10MB',
                confirmButtonColor: '#dc3545'
            });
            return;
        }

        const formData = new FormData(form);

        modalSubirOrden.hide();

        Swal.fire({
            title: 'Subiendo orden validada...',
            html: `
            <div class="text-center py-3">
                <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Subiendo...</span>
                </div>
                <p class="text-muted mb-0">Procesando archivo, validando orden y creando orden de producción...</p>
            </div>
        `,
            allowOutsideClick: false,
            showConfirmButton: false
        });

        fetch(`/panel/orders/${ordenId}/subir-firmada/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let mensajeHtml = `
                <p>La orden ha sido validada correctamente.</p>
                <p class="text-muted">Estado: <strong>Validado</strong></p>
            `;

                    if (data.orden_produccion_creada) {
                        mensajeHtml += `
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-cogs me-2"></i>
                        <strong>¡Orden de producción creada automáticamente!</strong>
                        <p class="mb-0 mt-1">Se ha generado una nueva orden de producción con todos los datos de esta toma.</p>
                    </div>
                `;
                    }

                    Swal.fire({
                        icon: 'success',
                        title: '¡Orden Validada!',
                        html: mensajeHtml,
                        confirmButtonColor: '#28a745',
                        showCancelButton: true,
                        cancelButtonText: 'Cerrar',
                        confirmButtonText: data.orden_produccion_creada ? 'Ver Órdenes Producción' : 'Aceptar'
                    }).then((result) => {
                        if (result.isConfirmed && data.orden_produccion_creada) {
                            window.location.href = '/panel/ordenes-produccion/';
                        } else {
                            window.location.reload();
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Error al subir la orden validada',
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de conexión',
                    text: 'No se pudo subir el archivo',
                    confirmButtonColor: '#dc3545'
                });
            });
    }

    function abrirModalDescargaOrden(ordenId, codigo, tieneValidado, ordenGeneradaId) {
        ordenDescargaActual = ordenId;
        ordenGeneradaActualId = ordenGeneradaId;
        document.getElementById('descargaOrdenCodigo').textContent = codigo;

        const btnValidada = document.getElementById('btnDescargaValidada');
        const msgNoValidada = document.getElementById('msgNoValidada');

        if (tieneValidado) {
            btnValidada.disabled = false;
            btnValidada.classList.remove('opacity-50');
            msgNoValidada.style.display = 'none';
        } else {
            btnValidada.disabled = true;
            btnValidada.classList.add('opacity-50');
            msgNoValidada.style.display = 'block';
        }

        modalOpcionesDescarga.show();
    }

    function procederDescargaSistema() {
        if (ordenDescargaActual) {
            cargarPlantillasYMostrarModal(ordenDescargaActual);
        }
    }

    function cargarPlantillasYMostrarModal(ordenId) {
        modalOpcionesDescarga.hide();

        const selectPlantilla = document.getElementById('plantillaOrden');
        selectPlantilla.innerHTML = '<option value="">Cargando...</option>';

        modalSeleccionarPlantilla.show();

        fetch(`/panel/orders/${ordenId}/plantillas/`)
            .then(response => response.json())
            .then(data => {
                selectPlantilla.innerHTML = '';
                if (data.plantillas && data.plantillas.length > 0) {
                    data.plantillas.forEach(plantilla => {
                        const option = document.createElement('option');
                        option.value = plantilla.id;
                        option.textContent = plantilla.nombre;
                        if (plantilla.is_default) option.selected = true;
                        selectPlantilla.appendChild(option);
                    });
                } else {
                    selectPlantilla.innerHTML = '<option value="">No hay plantillas disponibles</option>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                selectPlantilla.innerHTML = '<option value="">Error al cargar plantillas</option>';
            });
    }

    function generarOrdenConPlantilla() {
        const plantillaId = document.getElementById('plantillaOrden').value;
        if (!plantillaId) {
            Swal.fire('Error', 'Debe seleccionar una plantilla', 'error');
            return;
        }

        modalSeleccionarPlantilla.hide();

        Swal.fire({
            title: 'Generando PDF...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch(`/panel/orders/${ordenDescargaActual}/generar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ plantilla_id: plantillaId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.archivo_url) {
                        window.location.href = data.archivo_url;
                    }

                    Swal.fire({
                        icon: 'success',
                        title: '¡Orden Generada!',
                        text: 'El PDF se ha generado correctamente',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire('Error', data.message || 'Error al generar la orden', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Error de conexión al generar la orden', 'error');
            });
    }

    function procederDescargaValidado() {
        if (ordenDescargaActual) {
            window.location.href = `/panel/orders/${ordenDescargaActual}/descargar-validado/`;
            modalOpcionesDescarga.hide();
        }
    }

    function subirOrdenValidada(ordenId, codigo) {
        document.getElementById('subir_orden_id').value = ordenId;
        document.getElementById('archivo_orden').value = '';
        modalSubirOrden.show();
    }
</script>
{% endblock %}