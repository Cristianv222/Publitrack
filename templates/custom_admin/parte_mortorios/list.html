{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block title %}Gesti√≥n de Partes Mortorios - PubliTrack{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .badge-estado {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .badge-pendiente {
        background-color: #fff3cd;
        color: #856404;
    }
    .badge-al_aire {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .badge-finalizado {
        background-color: #d4edda;
        color: #155724;
    }
    .badge-cancelado {
        background-color: #f8d7da;
        color: #721c24;
    }
    .badge-urgencia {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    .badge-normal {
        background-color: #28a745;
        color: white;
    }
    .badge-urgente {
        background-color: #ffc107;
        color: #000;
    }
    .badge-muy_urgente {
        background-color: #dc3545;
        color: white;
    }
    .parte-number {
        font-weight: 600;
        color: #2c5aa0;
    }
    .precio-total {
        font-weight: 600;
        color: #28a745;
    }
    .familia-info {
        font-size: 0.85rem;
        color: #666;
    }
    .info-label {
        font-weight: 600;
        color: #495057;
    }
    .info-value {
        color: #6c757d;
    }
    .btn-estado {
        margin: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-cross me-2"></i>Gesti√≥n de Partes Mortorios
            </h2>
            <p class="text-muted mb-0">Administra las transmisiones por fallecimiento</p>
        </div>
        <button class="btn btn-primary" onclick="abrirModalCrear()">
            <i class="fas fa-plus me-2"></i>Nuevo Parte Mortorio
        </button>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-primary">{{ total_partes }}</h3>
                <p>Total de Partes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-warning">{{ partes_pendientes }}</h3>
                <p>Pendientes</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-info">{{ partes_al_aire }}</h3>
                <p>Al Aire</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="text-success">{{ partes_finalizados }}</h3>
                <p>Finalizados</p>
            </div>
        </div>
    </div>

    <!-- Tabla de Partes Mortorios -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>C√≥digo</th>
                            <th>Fallecido</th>
                            <th>Informaci√≥n Familiar</th>
                            <th>Cliente</th>
                            <th>F. Fallecimiento</th>
                            <th>Transmisi√≥n</th>
                            <th>Precio</th>
                            <th>Urgencia</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for parte in partes %}
                        <tr>
                            <td>
                                <span class="parte-number">{{ parte.codigo }}</span>
                            </td>
                            <td>
                                <strong>{{ parte.nombre_fallecido }}</strong>
                            </td>
                            <td>
                                <div class="familia-info">
                                    {% if parte.nombre_esposa %}
                                    <div>üíç {{ parte.nombre_esposa }}</div>
                                    {% endif %}
                                    {% if parte.cantidad_hijos > 0 %}
                                    <div>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ {{ parte.cantidad_hijos }} hijos</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {{ parte.cliente.get_full_name|default:parte.cliente.username }}
                            </td>
                            <td>
                                {{ parte.fecha_fallecimiento|date:"d/m/Y" }}
                            </td>
                            <td>
                                {% if parte.fecha_inicio_transmision %}
                                {{ parte.fecha_inicio_transmision|date:"d/m/Y" }}
                                {% if parte.fecha_fin_transmision and parte.fecha_fin_transmision != parte.fecha_inicio_transmision %}
                                <br><small>al {{ parte.fecha_fin_transmision|date:"d/m/Y" }}</small>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">No programado</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="precio-total">S/ {{ parte.precio_total|floatformat:2 }}</span>
                            </td>
                            <td>
                                <span class="badge-urgencia badge-{{ parte.urgencia }}">
                                    {{ parte.get_urgencia_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge-estado badge-{{ parte.estado }}">
                                    {{ parte.get_estado_display }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group-vertical btn-group-sm">
                                    <button class="btn btn-info btn-sm mb-1" 
                                            onclick="verDetalleModal({{ parte.id }})"
                                            title="Ver detalles">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-warning btn-sm mb-1" 
                                            onclick="editarParte({{ parte.id }})"
                                            title="Editar">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    
                                    <!-- Botones para cambiar estado -->
                                    {% if parte.estado == 'pendiente' %}
                                    <button class="btn btn-success btn-sm mb-1 btn-estado" 
                                            onclick="cambiarEstado({{ parte.id }}, 'al_aire')"
                                            title="Enviar al Aire">
                                        <i class="fas fa-broadcast-tower"></i> Al Aire
                                    </button>
                                    {% endif %}
                                    
                                    {% if parte.estado == 'al_aire' %}
                                    <button class="btn btn-primary btn-sm mb-1 btn-estado" 
                                            onclick="cambiarEstado({{ parte.id }}, 'finalizado')"
                                            title="Marcar como Finalizado">
                                        <i class="fas fa-check-circle"></i> Finalizar
                                    </button>
                                    {% endif %}
                                    
                                    {% if parte.estado != 'finalizado' %}
                                    <button class="btn btn-secondary btn-sm mb-1 btn-estado" 
                                            onclick="cambiarEstado({{ parte.id }}, 'pendiente')"
                                            title="Volver a Pendiente">
                                        <i class="fas fa-clock"></i> Pendiente
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No se encontraron partes mortorios</p>
                                <button class="btn btn-primary" onclick="abrirModalCrear()">
                                    <i class="fas fa-plus me-2"></i>Crear Primer Parte Mortorio
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Modal para ver detalles -->
<div class="modal fade" id="modalDetalleParte" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Parte Mortorio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalleParteContent">
                <!-- Contenido se carga din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar parte mortorio -->
<div class="modal fade" id="modalParteMortorio" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalParteTitulo">Nuevo Parte Mortorio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formParteMortorio">
                    {% csrf_token %}
                    
                    <!-- Informaci√≥n del Fallecido -->
                    <h6 class="mb-3 text-primary">üìã Informaci√≥n del Fallecido</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Nombre del Fallecido *</label>
                            <input type="text" class="form-control" name="nombre_fallecido" required>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" name="fecha_nacimiento">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Fallecimiento *</label>
                            <input type="date" class="form-control" name="fecha_fallecimiento" required>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n Familiar -->
                    <h6 class="mb-3 text-primary">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n Familiar</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Nombre de la Esposa/Esposo</label>
                            <input type="text" class="form-control" name="nombre_esposa" placeholder="Nombre del c√≥nyuge">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cantidad de Hijos</label>
                            <input type="number" class="form-control" name="cantidad_hijos" value="0" min="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hijos Vivos</label>
                            <input type="number" class="form-control" name="hijos_vivos" value="0" min="0">
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Hijos Fallecidos</label>
                            <input type="number" class="form-control" name="hijos_fallecidos" value="0" min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nombres de los Hijos</label>
                            <input type="text" class="form-control" name="nombres_hijos" placeholder="Separados por comas">
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Familiares Adicionales</label>
                            <textarea class="form-control" name="familiares_adicionales" rows="2" 
                                      placeholder="Otros familiares importantes (hermanos, padres, etc.)"></textarea>
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n de la Ceremonia -->
                    <h6 class="mb-3 text-primary">‚õ™ Informaci√≥n de la Ceremonia</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Ceremonia</label>
                            <select class="form-select" name="tipo_ceremonia">
                                <option value="misa">Misa</option>
                                <option value="velatorio">Velatorio</option>
                                <option value="ambos">Misa y Velatorio</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cliente/Familiar *</label>
                            <select class="form-select" name="cliente_id" required>
                                <option value="">Seleccionar cliente...</option>
                                <!-- Se cargar√°n din√°micamente -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Misa/Velatorio</label>
                            <input type="date" class="form-control" name="fecha_misa">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Hora de Misa/Velatorio</label>
                            <input type="time" class="form-control" name="hora_misa">
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Lugar de Misa/Velatorio</label>
                            <input type="text" class="form-control" name="lugar_misa" placeholder="Direcci√≥n del lugar de la ceremonia">
                        </div>
                    </div>
                    
                    <!-- Informaci√≥n de Transmisi√≥n -->
                    <h6 class="mb-3 text-primary">üì∫ Informaci√≥n de Transmisi√≥n</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Inicio Transmisi√≥n</label>
                            <input type="date" class="form-control" name="fecha_inicio_transmision">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Fin Transmisi√≥n</label>
                            <input type="date" class="form-control" name="fecha_fin_transmision">
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Hora de Transmisi√≥n</label>
                            <input type="time" class="form-control" name="hora_transmision">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Duraci√≥n (minutos)</label>
                            <input type="number" class="form-control" name="duracion_transmision" value="1" min="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Repeticiones por d√≠a</label>
                            <input type="number" class="form-control" name="repeticiones_dia" value="1" min="1">
                        </div>
                    </div>
                    
                    <!-- Precio Total -->
                    <h6 class="mb-3 text-primary">üí∞ Precio Total</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Precio Total (S/) *</label>
                            <div class="input-group">
                                <span class="input-group-text">S/</span>
                                <input type="number" class="form-control" name="precio_total" step="0.01" min="0" value="0.00" required>
                            </div>
                            <small class="text-muted">Ingrese el precio total a cobrar por este parte mortorio</small>
                        </div>
                    </div>
                    
                    <!-- Configuraci√≥n -->
                    <h6 class="mb-3 text-primary">‚öôÔ∏è Configuraci√≥n</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Urgencia</label>
                            <select class="form-select" name="urgencia">
                                <option value="normal">Normal</option>
                                <option value="urgente">Urgente</option>
                                <option value="muy_urgente">Muy Urgente</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estado</label>
                            <select class="form-select" name="estado">
                                <option value="pendiente">Pendiente</option>
                                <option value="al_aire">Al Aire</option>
                                <option value="finalizado">Finalizado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Mensaje Personalizado</label>
                            <textarea class="form-control" name="mensaje_personalizado" rows="3" 
                                      placeholder="Mensaje especial para la transmisi√≥n..."></textarea>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" name="observaciones" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarParteMortorio()">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let parteEditando = null;

function abrirModalCrear() {
    document.getElementById('modalParteTitulo').textContent = 'Nuevo Parte Mortorio';
    document.getElementById('formParteMortorio').reset();
    parteEditando = null;
    
    cargarClientes();
    
    const modal = new bootstrap.Modal(document.getElementById('modalParteMortorio'));
    modal.show();
}

function cargarClientes() {
    fetch('/panel/api/clientes-activos/')
        .then(response => response.json())
        .then(data => {
            const selectCliente = document.querySelector('select[name="cliente_id"]');
            selectCliente.innerHTML = '<option value="">Seleccionar cliente...</option>';
            
            if (data.success && data.clientes) {
                data.clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nombre_completo || cliente.empresa || cliente.username;
                    selectCliente.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error cargando clientes:', error);
        });
}

function guardarParteMortorio() {
    const form = document.getElementById('formParteMortorio');
    const formData = new FormData(form);
    
    // Convertir FormData a objeto JSON
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Validaciones b√°sicas
    if (!data.nombre_fallecido || !data.fecha_fallecimiento || !data.cliente_id || !data.precio_total) {
        alert('Por favor complete los campos obligatorios (*)');
        return;
    }
    
    const url = parteEditando 
        ? `/panel/parte-mortorios/${parteEditando}/editar/`
        : '/panel/parte-mortorios/crear/';
    
    const method = parteEditando ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el parte mortorio');
    });
}

function verDetalleModal(parteId) {
    fetch(`/panel/parte-mortorios/${parteId}/detalle/`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('detalleParteContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">üìã Informaci√≥n del Fallecido</h6>
                        <p><span class="info-label">Nombre:</span> <span class="info-value">${data.nombre_fallecido}</span></p>
                        ${data.fecha_nacimiento ? `<p><span class="info-label">Fecha Nacimiento:</span> <span class="info-value">${data.fecha_nacimiento}</span></p>` : ''}
                        <p><span class="info-label">Fecha Fallecimiento:</span> <span class="info-value">${data.fecha_fallecimiento}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n Familiar</h6>
                        ${data.nombre_esposa ? `<p><span class="info-label">Esposa/Esposo:</span> <span class="info-value">${data.nombre_esposa}</span></p>` : ''}
                        ${data.cantidad_hijos > 0 ? `
                            <p><span class="info-label">Hijos:</span> <span class="info-value">${data.cantidad_hijos} total (${data.hijos_vivos} vivos, ${data.hijos_fallecidos} fallecidos)</span></p>
                            ${data.nombres_hijos ? `<p><span class="info-label">Nombres:</span> <span class="info-value">${data.nombres_hijos}</span></p>` : ''}
                        ` : ''}
                        ${data.familiares_adicionales ? `<p><span class="info-label">Familiares:</span> <span class="info-value">${data.familiares_adicionales}</span></p>` : ''}
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">‚õ™ Informaci√≥n de la Ceremonia</h6>
                        <p><span class="info-label">Tipo:</span> <span class="info-value">${data.tipo_ceremonia}</span></p>
                        ${data.fecha_misa ? `<p><span class="info-label">Fecha:</span> <span class="info-value">${data.fecha_misa} ${data.hora_misa ? 'a las ' + data.hora_misa : ''}</span></p>` : ''}
                        ${data.lugar_misa ? `<p><span class="info-label">Lugar:</span> <span class="info-value">${data.lugar_misa}</span></p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">üì∫ Informaci√≥n de Transmisi√≥n</h6>
                        ${data.fecha_inicio_transmision ? `
                            <p><span class="info-label">Per√≠odo:</span> <span class="info-value">${data.fecha_inicio_transmision} al ${data.fecha_fin_transmision}</span></p>
                            <p><span class="info-label">Hora:</span> <span class="info-value">${data.hora_transmision}</span></p>
                            <p><span class="info-label">Duraci√≥n:</span> <span class="info-value">${data.duracion_transmision} min √ó ${data.repeticiones_dia} rep/d√≠a</span></p>
                        ` : '<p class="text-muted">No programado</p>'}
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">üí∞ Informaci√≥n de Precio</h6>
                        <p><span class="info-label">Precio total:</span> <span class="info-value precio-total">S/ ${data.precio_total}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">‚öôÔ∏è Configuraci√≥n</h6>
                        <p><span class="info-label">Estado:</span> <span class="badge-estado badge-${data.estado}">${data.estado}</span></p>
                        <p><span class="info-label">Urgencia:</span> <span class="badge-urgencia badge-${data.urgencia}">${data.urgencia}</span></p>
                        <p><span class="info-label">Cliente:</span> <span class="info-value">${data.cliente_nombre}</span></p>
                    </div>
                </div>
                
                ${data.mensaje_personalizado ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">üí¨ Mensaje Personalizado</h6>
                        <div class="alert alert-info">
                            ${data.mensaje_personalizado}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${data.observaciones ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">üìù Observaciones</h6>
                        <p class="info-value">${data.observaciones}</p>
                    </div>
                </div>
                ` : ''}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalleParte'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los detalles del parte mortorio');
        });
}

function editarParte(parteId) {
    fetch(`/panel/parte-mortorios/${parteId}/detalle/`)
        .then(response => response.json())
        .then(data => {
            parteEditando = parteId;
            document.getElementById('modalParteTitulo').textContent = 'Editar Parte Mortorio';
            
            // Llenar el formulario con los datos existentes
            Object.keys(data).forEach(key => {
                const input = document.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = data[key] || '';
                }
            });
            
            cargarClientes();
            
            const modal = new bootstrap.Modal(document.getElementById('modalParteMortorio'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos del parte mortorio');
        });
}

function cambiarEstado(parteId, nuevoEstado) {
    const estados = {
        'pendiente': 'Pendiente',
        'al_aire': 'Al Aire', 
        'finalizado': 'Finalizado'
    };
    
    if (confirm(`¬øEst√°s seguro de cambiar el estado a "${estados[nuevoEstado]}"?`)) {
        fetch(`/panel/parte-mortorios/${parteId}/cambiar-estado/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                estado: nuevoEstado
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cambiar el estado');
        });
    }
}
</script>
{% endblock %}