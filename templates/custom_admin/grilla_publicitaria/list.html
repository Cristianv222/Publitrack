{% extends 'custom_admin/base_admin.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-calendar-alt text-primary me-2"></i>
            Grilla Publicitaria
        </h1>
        
        {% if grilla_available %}
        <div class="btn-group">
            <button class="btn btn-primary" onclick="generarUbicacionesAutomaticas()">
                <i class="fas fa-magic me-2"></i>Generar Ubicaciones
            </button>
            <button class="btn btn-success" onclick="generarGrillaAutomatica()">
                <i class="fas fa-robot me-2"></i>Generar Autom치tica
            </button>
        </div>
        {% endif %}
    </div>

    {% if not grilla_available %}
        <div class="alert alert-warning">
            <h4 class="alert-heading">M칩dulo no disponible</h4>
            <p class="mb-0">{{ error|default:"Los m칩dulos necesarios no est치n disponibles." }}</p>
        </div>
    {% else %}
        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <label for="programacion_id" class="form-label">Programaci칩n Semanal</label>
                        <select name="programacion_id" id="programacion_id" class="form-select" onchange="this.form.submit()">
                            <option value="">Seleccionar programaci칩n...</option>
                            {% for programacion in programaciones %}
                                <option value="{{ programacion.id }}" 
                                    {% if programacion_actual and programacion.id == programacion_actual.id %}selected{% endif %}>
                                    {{ programacion.nombre }} ({{ programacion.fecha_inicio_semana }} - {{ programacion.fecha_fin_semana }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Selecciona la programaci칩n semanal para ver y gestionar la grilla publicitaria
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% if programacion_actual %}
        <!-- Estad칤sticas -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card bg-primary text-white mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    Total Cu침as
                                </div>
                                <div class="h5 mb-0">{{ total_cu침as }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-bullhorn fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card bg-success text-white mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    Programadas
                                </div>
                                <div class="h5 mb-0">{{ cu침as_programadas }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card bg-warning text-white mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    Pendientes
                                </div>
                                <div class="h5 mb-0">{{ cu침as_pendientes }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card bg-info text-white mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                    Ingresos Proyectados
                                </div>
                                <div class="h5 mb-0">${{ ingresos_totales|floatformat:2 }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-dollar-sign fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendario Grilla - Mismo estilo que programaci칩n del canal -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar me-2"></i>
                    Grilla Publicitaria - {{ programacion_actual.nombre }}
                    <small class="text-muted">({{ programacion_actual.fecha_inicio_semana }} al {{ programacion_actual.fecha_fin_semana }})</small>
                </h5>
            </div>
            <div class="card-body">
                
                <!-- Leyenda -->
                <div class="leyenda-superior mb-3">
                    <div class="d-flex flex-wrap gap-3 align-items-center">
                        <span class="text-muted small fw-bold">Leyenda:</span>
                        <span class="badge" style="background: #4dabf7; color: white;">
                            <i class="fas fa-tv me-1"></i>Programaci칩n
                        </span>
                        <span class="badge" style="background: #51cf66; color: white;">
                            <i class="fas fa-ad me-1"></i>Publicidad
                        </span>
                        <span class="badge" style="background: #ffd43b; color: black;">
                            <i class="fas fa-clock me-1"></i>Pausa Disponible
                        </span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover grilla-calendario">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 100px;">Hora</th>
                                {% for dia in dias_semana %}
                                    <th class="text-center">{{ dia }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for hora in horas_dia %}
                                <tr>
                                    <td class="fw-bold bg-light">{{ hora }}</td>
                                    {% for dia in dias_semana %}
                                        <td class="grilla-celda position-relative" 
                                            data-dia="{{ forloop.counter0 }}" 
                                            data-hora="{{ hora }}"
                                            style="min-height: 80px; vertical-align: top;">
                                            
                                            <!-- Bloques de Programaci칩n -->
                                            {% for bloque in calendario_data.dia.hora.bloques_programacion %}
                                                <div class="calendario-bloque mb-1"
                                                     style="background: {{ bloque.programa.color }}; border-left-color: {{ bloque.programa.color }};"
                                                     data-bs-toggle="tooltip" 
                                                     title="{{ bloque.programa.nombre }} - {{ bloque.hora_inicio }} a {{ bloque.hora_fin }}">
                                                    <div class="small text-white p-1">
                                                        <strong>{{ bloque.programa.nombre|truncatechars:20 }}</strong>
                                                        <br>
                                                        <small>{{ bloque.hora_inicio|time:"H:i" }} - {{ bloque.hora_fin|time:"H:i" }}</small>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            
                                            <!-- Ubicaciones Publicitarias -->
                                            {% for ubicacion in calendario_data.dia.hora.ubicaciones_publicitarias %}
                                                <div class="ubicacion-publicitaria mb-1 p-2 rounded small"
                                                     style="background: #ffd43b; border-left: 3px solid #f59f00;"
                                                     data-bs-toggle="tooltip"
                                                     title="Pausa Publicitaria - {{ ubicacion.duracion_disponible }} - Capacidad: {{ ubicacion.capacidad_cu침as }} cu침as">
                                                    <div class="fw-bold text-dark">游꿢 {{ ubicacion.nombre }}</div>
                                                    <div class="text-dark">{{ ubicacion.duracion_disponible }}</div>
                                                    <div class="text-dark small">
                                                        <i class="fas fa-bullhorn"></i> {{ ubicacion.capacidad_cu침as }} espacios
                                                    </div>
                                                    
                                                    <!-- Asignaciones en esta ubicaci칩n -->
                                                    {% for asignacion in calendario_data.dia.hora.asignaciones %}
                                                        {% if asignacion.ubicacion.id == ubicacion.id %}
                                                        <div class="asignacion-cuna mt-1 p-1 rounded small"
                                                             style="background: #51cf66; color: white;"
                                                             data-bs-toggle="tooltip"
                                                             title="{{ asignacion.cu침a.titulo }} - {{ asignacion.cu침a.cliente.get_full_name }}">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <strong>{{ asignacion.cu침a.codigo }}</strong>
                                                                    <br>
                                                                    <small>{{ asignacion.cu침a.duracion_planeada }}s</small>
                                                                </div>
                                                                <div class="cursor-pointer text-danger" 
                                                                     onclick="eliminarAsignacion({{ asignacion.id }})">
                                                                    <i class="fas fa-times"></i>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <!-- Bot칩n para asignar cu침a -->
                                                    {% with asignaciones_count=calendario_data.dia.hora.asignaciones|length %}
                                                    {% if asignaciones_count < ubicacion.capacidad_cu침as %}
                                                    <div class="text-center mt-1">
                                                        <button class="btn btn-sm btn-success py-0 px-2"
                                                                onclick="abrirModalAsignar('{{ forloop.parentloop.counter0 }}', '{{ hora }}', {{ ubicacion.id }})">
                                                            <i class="fas fa-plus"></i> Cu침a
                                                        </button>
                                                    </div>
                                                    {% else %}
                                                    <div class="text-center mt-1">
                                                        <small class="text-muted">Lleno</small>
                                                    </div>
                                                    {% endif %}
                                                    {% endwith %}
                                                </div>
                                            {% endfor %}
                                            
                                            <!-- Si no hay programaci칩n ni publicidad -->
                                            {% if not calendario_data.dia.hora.bloques_programacion and not calendario_data.dia.hora.ubicaciones_publicitarias %}
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-plus-circle cursor-pointer"
                                                       onclick="abrirModalCrearUbicacion('{{ forloop.counter0 }}', '{{ hora }}')"
                                                       data-bs-toggle="tooltip" 
                                                       title="Crear ubicaci칩n publicitaria"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cu침as Disponibles -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Cu침as Disponibles para Programar
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for cu침a in cu침as_disponibles %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 border-success">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <span class="badge" style="background: {{ cu침a.categoria.color_codigo|default:'#007bff' }}; color: white;">
                                            {{ cu침a.codigo }}
                                        </span>
                                        {{ cu침a.titulo }}
                                    </h6>
                                    <p class="card-text small mb-1">
                                        <strong>Cliente:</strong> {{ cu침a.cliente.get_full_name }}<br>
                                        <strong>Duraci칩n:</strong> {{ cu침a.duracion_planeada }}s<br>
                                        <strong>Precio:</strong> ${{ cu침a.precio_total }}<br>
                                        <strong>Per칤odo:</strong> {{ cu침a.fecha_inicio }} - {{ cu침a.fecha_fin }}<br>
                                        <strong>Repeticiones/d칤a:</strong> {{ cu침a.repeticiones_dia }}
                                    </p>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-user me-1"></i>{{ cu침a.vendedor_asignado.get_full_name|default:"Sin vendedor" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                No hay cu침as disponibles para programar
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            Selecciona una programaci칩n semanal para comenzar
        </div>
        {% endif %}
        
    {% endif %}
</div>

<!-- Modal para asignar cu침a -->
<div class="modal fade" id="modalAsignarCu침a" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Cu침a Publicitaria</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAsignarCu침a">
                    <input type="hidden" id="dia_semana" name="dia_semana">
                    <input type="hidden" id="hora_emision" name="hora_emision">
                    <input type="hidden" id="ubicacion_id" name="ubicacion_id">
                    
                    <div class="mb-3">
                        <label for="cu침a_id" class="form-label">Seleccionar Cu침a</label>
                        <select id="cu침a_id" name="cu침a_id" class="form-select" required>
                            <option value="">Seleccionar cu침a...</option>
                            {% for cu침a in cu침as_disponibles %}
                                <option value="{{ cu침a.id }}" data-duracion="{{ cu침a.duracion_planeada }}">
                                    {{ cu침a.codigo }} - {{ cu침a.titulo }} ({{ cu침a.duracion_planeada }}s) - {{ cu침a.cliente.get_full_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fecha_emision" class="form-label">Fecha de Emisi칩n</label>
                        <input type="date" id="fecha_emision" name="fecha_emision" class="form-control" required>
                    </div>
                    
                    <div class="alert alert-info small">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="infoUbicacion"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="asignarCu침a()">Asignar Cu침a</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear ubicaci칩n -->
<div class="modal fade" id="modalCrearUbicacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Ubicaci칩n Publicitaria</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearUbicacion">
                    <input type="hidden" id="crear_dia_semana" name="dia_semana">
                    <input type="hidden" id="crear_hora_emision" name="hora_emision">
                    
                    <div class="mb-3">
                        <label for="bloque_id" class="form-label">Bloque de Programaci칩n</label>
                        <select id="bloque_id" name="bloque_id" class="form-select" required>
                            <option value="">Seleccionar bloque...</option>
                            {% for bloque in bloques_semana %}
                                <option value="{{ bloque.id }}">
                                    {{ bloque.get_dia_semana_display }} {{ bloque.hora_inicio }} - {{ bloque.programa.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tipo_pausa" class="form-label">Tipo de Pausa</label>
                        <select id="tipo_pausa" name="tipo_pausa" class="form-select" required>
                            <option value="corta">Pausa Corta (30 seg)</option>
                            <option value="media">Pausa Media (60 seg)</option>
                            <option value="larga">Pausa Larga (90 seg)</option>
                            <option value="especial">Pausa Especial (120 seg)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="nombre_ubicacion" class="form-label">Nombre de la Ubicaci칩n</label>
                        <input type="text" id="nombre_ubicacion" name="nombre" class="form-control" required 
                               placeholder="Ej: Pausa Publicitaria Ma침ana">
                    </div>
                    
                    <div class="mb-3">
                        <label for="capacidad" class="form-label">Capacidad de Cu침as</label>
                        <input type="number" id="capacidad" name="capacidad" class="form-control" 
                               min="1" max="5" value="3" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearUbicacion()">Crear Ubicaci칩n</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Estilos iguales al de programaci칩n del canal */
.calendario-grid {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
    gap: 1px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.calendario-header {
    background: #6c757d;
    color: white;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
}

.calendario-hora {
    background: #f8f9fa;
    padding: 8px;
    text-align: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: #495057;
    border-right: 1px solid #dee2e6;
}

.calendario-celda {
    background: white;
    min-height: 60px;
    padding: 4px;
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    position: relative;
}

.calendario-bloque {
    background: #4dabf7;
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-bottom: 2px;
    cursor: pointer;
    border-left: 3px solid;
}

.ubicacion-publicitaria {
    border: 1px dashed #ffd43b;
    background: #fff9db;
}

.asignacion-cuna {
    border-left: 3px solid #2b8a3e;
}

.leyenda-superior {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    border: 1px solid #e9ecef;
}

.cursor-pointer {
    cursor: pointer;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Funciones para la grilla publicitaria
function abrirModalAsignar(dia, hora, ubicacionId) {
    document.getElementById('dia_semana').value = dia;
    document.getElementById('hora_emision').value = hora;
    document.getElementById('ubicacion_id').value = ubicacionId;
    
    // Establecer fecha por defecto (calculada desde la programaci칩n)
    const today = new Date();
    const daysUntilMonday = (1 - today.getDay() + 7) % 7;
    const nextMonday = new Date(today);
    nextMonday.setDate(today.getDate() + daysUntilMonday + parseInt(dia));
    document.getElementById('fecha_emision').value = nextMonday.toISOString().split('T')[0];
    
    // Actualizar informaci칩n de la ubicaci칩n
    document.getElementById('infoUbicacion').textContent = 
        `Asignando cu침a para el ${getDiaNombre(dia)} a las ${hora} en la ubicaci칩n seleccionada`;
    
    new bootstrap.Modal(document.getElementById('modalAsignarCu침a')).show();
}

function abrirModalCrearUbicacion(dia, hora) {
    document.getElementById('crear_dia_semana').value = dia;
    document.getElementById('crear_hora_emision').value = hora;
    
    new bootstrap.Modal(document.getElementById('modalCrearUbicacion')).show();
}

function getDiaNombre(diaIndex) {
    const dias = ['Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado', 'Domingo'];
    return dias[parseInt(diaIndex)];
}

function asignarCu침a() {
    const formData = {
        cu침a_id: document.getElementById('cu침a_id').value,
        dia_semana: document.getElementById('dia_semana').value,
        hora_emision: document.getElementById('hora_emision').value,
        fecha_emision: document.getElementById('fecha_emision').value,
        ubicacion_id: document.getElementById('ubicacion_id').value
    };
    
    if (!formData.cu침a_id) {
        alert('Por favor selecciona una cu침a');
        return;
    }
    
    fetch("{% url 'custom_admin:grilla_asignar_cuna_api' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al asignar la cu침a');
    });
}

function crearUbicacion() {
    const formData = {
        bloque_id: document.getElementById('bloque_id').value,
        dia_semana: document.getElementById('crear_dia_semana').value,
        hora_emision: document.getElementById('crear_hora_emision').value,
        tipo_pausa: document.getElementById('tipo_pausa').value,
        nombre: document.getElementById('nombre_ubicacion').value,
        capacidad: document.getElementById('capacidad').value
    };
    
    fetch("{% url 'custom_admin:grilla_crear_ubicacion_api' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function eliminarAsignacion(asignacionId) {
    if (confirm('쮼st치 seguro de eliminar esta asignaci칩n?')) {
        fetch(`{% url 'custom_admin:grilla_eliminar_asignacion_api' 0 %}`.replace('0', asignacionId), {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function generarUbicacionesAutomaticas() {
    if (!confirm('쮾enerar ubicaciones publicitarias autom치ticamente para todos los bloques?')) {
        return;
    }
    
    fetch("{% url 'custom_admin:grilla_generar_ubicaciones_api' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
            programacion_id: '{{ programacion_actual.id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function generarGrillaAutomatica() {
    if (!confirm('쮾enerar grilla publicitaria autom치ticamente?')) {
        return;
    }
    
    fetch(`{% url 'custom_admin:grilla_generar_automatica_api' 0 %}`.replace('0', {{ programacion_actual.id|default:0 }}), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

// Tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>  
{% endblock %}