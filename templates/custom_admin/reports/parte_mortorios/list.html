{% extends "custom_admin/base_admin.html" %}
{% load static %}

{% block title %}Reportes de Partes Mortuorias{% endblock %}

{% block extra_css %}
<!-- Incluir Plotly.js desde CDN en el head -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
/* Estilos del dashboard principal aplicados */
.dashboard-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
    border-radius: 0.75rem;
}
.dashboard-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

/* Paleta de colores pastel armoniosa */
.pastel-primary { background-color: #e3f2fd; border-left-color: #90caf9; }
.pastel-success { background-color: #e8f5e8; border-left-color: #81c784; }
.pastel-warning { background-color: #fff3e0; border-left-color: #ffb74d; }
.pastel-info { background-color: #e0f2f1; border-left-color: #4db6ac; }
.pastel-purple { background-color: #f3e5f5; border-left-color: #ba68c8; }
.pastel-orange { background-color: #fbe9e7; border-left-color: #ff8a65; }
.pastel-indigo { background-color: #e8eaf6; border-left-color: #7986cb; }
.pastel-teal { background-color: #e0f2f1; border-left-color: #4db6ac; }

/* Badges pastel */
.badge-pastel-primary { background-color: #e3f2fd; color: #1976d2; }
.badge-pastel-success { background-color: #e8f5e8; color: #388e3c; }
.badge-pastel-warning { background-color: #fff3e0; color: #f57c00; }
.badge-pastel-info { background-color: #e0f2f1; color: #00796b; }

/* Cards de estadísticas */
.stat-mini-card {
    border-radius: 0.5rem;
    border: none;
    transition: all 0.3s ease;
}
.stat-mini-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

/* Headers suaves en colores pastel */
.card-header-soft {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    border: none;
    font-weight: 600;
}

.card-header-success {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    color: #2e7d32;
    border: none;
    font-weight: 600;
}

.card-header-warning {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    color: #ef6c00;
    border: none;
    font-weight: 600;
}

/* Botón volver mejorado */
.btn-volver {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    border: 2px solid #bbdefb;
    transition: all 0.3s ease;
    font-weight: 500;
}
.btn-volver:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
    color: #1565c0;
    border-color: #90caf9;
}

/* Badges de estado en colores pastel */
.badge-solicitado { background-color: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
.badge-programado { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
.badge-transmitido { background-color: #e8f5e8; color: #388e3c; border: 1px solid #c8e6c9; }
.badge-cancelado { background-color: #f5f5f5; color: #616161; border: 1px solid #e0e0e0; }
.badge-pendiente { background-color: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
.badge-al_aire { background-color: #e8f5e8; color: #388e3c; border: 1px solid #c8e6c9; }
.badge-pausado { background-color: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
.badge-finalizado { background-color: #e0f2f1; color: #00796b; border: 1px solid #b2dfdb; }

.card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fc;
}

/* Mejoras para los gráficos */
.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.btn-outline-primary:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
}

/* Ajustes para gráficas Plotly */
.plotly-graph-div {
    width: 100% !important;
    min-height: 400px;
}

/* Mejoras visuales para las gráficas */
.js-plotly-plot .plotly .modebar {
    background: transparent !important;
}

.js-plotly-plot .plotly .main-svg {
    border-radius: 8px;
}

/* Bordes izquierdos para cards de estadísticas */
.border-left-primary { border-left: 0.25rem solid #90caf9 !important; }
.border-left-success { border-left: 0.25rem solid #81c784 !important; }
.border-left-info { border-left: 0.25rem solid #4db6ac !important; }
.border-left-warning { border-left: 0.25rem solid #ffb74d !important; }
.border-left-danger { border-left: 0.25rem solid #ef5350 !important; }
.border-left-secondary { border-left: 0.25rem solid #bdbdbd !important; }

/* Text colors pastel */
.text-pastel-primary { color: #1976d2; }
.text-pastel-success { color: #388e3c; }
.text-pastel-warning { color: #f57c00; }
.text-pastel-info { color: #00796b; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-cross fa-fw text-pastel-primary"></i> 
                Reportes de Partes Mortuorias
            </h1>
            <p class="mb-0">Dashboard y reportes de la gestión de partes mortuorios</p>
        </div>
        <div class="d-flex gap-2 align-items-start">
            <!-- Botón Volver al Panel de Reportes -->
            <a href="{% url 'custom_admin:reportes_dashboard' %}" 
               class="btn btn-volver btn-sm mt-3">
                <i class="fas fa-arrow-left fa-fw"></i> Volver a Reportes
            </a>
        </div>
    </div>

    {% if error %}
    <!-- Alertas de error -->
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong><i class="fas fa-exclamation-triangle fa-fw"></i> Error:</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
<!-- Estadísticas principales - PARTES MORTUORIOS -->
<div class="row mb-4">
    <!-- Total Partes Mortuorios -->
    <div class="col-xl-2 col-md-4 mb-4">
        <div class="card dashboard-card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-pastel-primary text-uppercase mb-1">
                            Total Partes Mortuorios
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_partes }}</div>
                        <small class="text-muted">Todos los estados</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-cross fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pendientes -->
    <div class="col-xl-2 col-md-4 mb-4">
        <div class="card dashboard-card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-pastel-warning text-uppercase mb-1">
                            Pendientes
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ partes_pendientes }}</div>
                        <small class="text-muted">Por programar</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Al Aire -->
    <div class="col-xl-2 col-md-4 mb-4">
        <div class="card dashboard-card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-pastel-success text-uppercase mb-1">
                            Al Aire
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ partes_al_aire }}</div>
                        <small class="text-muted">En transmisión</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-broadcast-tower fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pausados -->
    <div class="col-xl-2 col-md-4 mb-4">
        <div class="card dashboard-card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-pastel-info text-uppercase mb-1">
                            Pausados
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ partes_pausados }}</div>
                        <small class="text-muted">Transmisión pausada</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-pause-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Finalizados -->
    <div class="col-xl-2 col-md-4 mb-4">
        <div class="card dashboard-card border-left-secondary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                            Finalizados
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ partes_finalizados }}</div>
                        <small class="text-muted">Transmisión completada</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingresos Totales -->
    <div class="col-xl-2 col-md-4 mb-4">
        <div class="card dashboard-card border-left-danger shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Ingresos
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">${{ ingresos_totales }}</div>
                        <small class="text-muted">Totales</small>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- Gráficos Plotly -->
<div class="row">
    <!-- Gráfico de Estados (Pastel) -->
    <div class="col-xl-6 col-lg-6">
        <div class="card dashboard-card shadow mb-4">
            <div class="card-header card-header-soft">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-chart-pie fa-fw"></i> Partes Mortuorios por Estado
                </h6>
            </div>
            <div class="card-body">
                {% if grafica_pastel_html %}
                    {{ grafica_pastel_html|safe }}
                {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No se pudo generar la gráfica de estados
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Gráfico de Ingresos Mensuales (Barras) -->
    <div class="col-xl-6 col-lg-6">
        <div class="card dashboard-card shadow mb-4">
            <div class="card-header card-header-success">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-chart-line fa-fw"></i> Ingresos Mensuales
                </h6>
            </div>
            <div class="card-body">
                {% if grafica_barras_html %}
                    {{ grafica_barras_html|safe }}
                {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No se pudo generar la gráfica de ingresos
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    <!-- Tabla de Partes Recientes -->
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card shadow mb-4">
                <div class="card-header card-header-soft">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-list fa-fw"></i> Partes Mortuorios Recientes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Fallecido</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Urgencia</th>
                                    <th>Fecha Fallecimiento</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for parte in partes_recientes %}
                                <tr>
                                    <td>
                                        <strong>{{ parte.codigo }}</strong>
                                    </td>
                                    <td>{{ parte.nombre_fallecido }}</td>
                                    <td>{{ parte.cliente.get_full_name }}</td>
                                    <td>
                                        {% if parte.estado == 'solicitado' %}
                                            <span class="badge badge-solicitado">Solicitado</span>
                                        {% elif parte.estado == 'programado' %}
                                            <span class="badge badge-programado">Programado</span>
                                        {% elif parte.estado == 'transmitido' %}
                                            <span class="badge badge-transmitido">Transmitido</span>
                                        {% elif parte.estado == 'cancelado' %}
                                            <span class="badge badge-cancelado">Cancelado</span>
                                        {% elif parte.estado == 'pendiente' %}
                                            <span class="badge badge-pendiente">Pendiente</span>
                                        {% elif parte.estado == 'al_aire' %}
                                            <span class="badge badge-al_aire">Al Aire</span>
                                        {% elif parte.estado == 'pausado' %}
                                            <span class="badge badge-pausado">Pausado</span>
                                        {% elif parte.estado == 'finalizado' %}
                                            <span class="badge badge-finalizado">Finalizado</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ parte.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if parte.urgencia == 'normal' %}
                                            <span class="badge badge-pastel-primary">Normal</span>
                                        {% elif parte.urgencia == 'urgente' %}
                                            <span class="badge badge-pastel-warning">Urgente</span>
                                        {% elif parte.urgencia == 'muy_urgente' %}
                                            <span class="badge badge-pastel-danger">Muy Urgente</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ parte.urgencia }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ parte.fecha_fallecimiento|date:"d/m/Y" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="verDetalleParte({{ parte.id }})">
                                            <i class="fas fa-eye fa-fw"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No hay partes mortuorios recientes
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Filtros -->
<div class="modal fade" id="modalFiltros" tabindex="-1" aria-labelledby="modalFiltrosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header card-header-soft">
                <h5 class="modal-title" id="modalFiltrosLabel">
                    <i class="fas fa-filter fa-fw"></i> Filtros de Reporte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formFiltros">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                            <input type="date" class="form-control" id="fechaInicio" name="fecha_inicio">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaFin" class="form-label">Fecha Fin</label>
                            <input type="date" class="form-control" id="fechaFin" name="fecha_fin">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipoReporte" class="form-label">Tipo de Reporte</label>
                            <select class="form-select" id="tipoReporte" name="tipo_reporte">
                                <option value="estado">Estado de Partes</option>
                                <option value="urgencia">Por Urgencia</option>
                                <option value="ingresos">Ingresos</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="formato" class="form-label">Formato de Exportación</label>
                            <select class="form-select" id="formato" name="formato">
                                <option value="html">Vista Web</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" id="opcionesUrgencia" style="display: none;">
                        <div class="col-12 mb-3">
                            <label for="nivelUrgencia" class="form-label">Nivel de Urgencia</label>
                            <select class="form-select" id="nivelUrgencia" name="nivel_urgencia">
                                <option value="todos">Todos</option>
                                <option value="normal">Normal</option>
                                <option value="urgente">Urgente</option>
                                <option value="muy_urgente">Muy Urgente</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" id="opcionesIngresos" style="display: none;">
                        <div class="col-12 mb-3">
                            <label for="agruparPor" class="form-label">Agrupar Por</label>
                            <select class="form-select" id="agruparPor" name="agrupar_por">
                                <option value="mes">Mes</option>
                                <option value="estado">Estado</option>
                                <option value="cliente">Cliente</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                    <i class="fas fa-check fa-fw"></i> Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle Parte -->
<div class="modal fade" id="modalDetalleParte" tabindex="-1" aria-labelledby="modalDetalleParteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header card-header-soft">
                <h5 class="modal-title" id="modalDetalleParteLabel">
                    <i class="fas fa-cross fa-fw"></i> Detalle del Parte Mortuorio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detalleParteContent">
                <!-- Contenido cargado via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script>
// Función para ver detalle de parte mortuorio
function verDetalleParte(parteId) {
    const contenido = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando detalles del parte mortuorio...</p>
        </div>
    `;
    
    document.getElementById('detalleParteContent').innerHTML = contenido;
    
    // Simular AJAX call
    setTimeout(() => {
        const detalle = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Información del Fallecido</h6>
                    <p><strong>Nombre:</strong> Juan Pérez García</p>
                    <p><strong>Edad:</strong> 78 años</p>
                    <p><strong>Fecha Fallecimiento:</strong> 15/12/2024</p>
                    <p><strong>DNI:</strong> 12345678A</p>
                </div>
                <div class="col-md-6">
                    <h6>Información del Cliente</h6>
                    <p><strong>Cliente:</strong> Familia Pérez Rodríguez</p>
                    <p><strong>Contacto:</strong> 555-1234</p>
                    <p><strong>Estado:</strong> <span class="badge badge-programado">Programado</span></p>
                    <p><strong>Urgencia:</strong> <span class="badge badge-pastel-primary">Normal</span></p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Detalles de la Ceremonia</h6>
                    <p><strong>Tipo:</strong> Misa</p>
                    <p><strong>Fecha y Hora:</strong> 16/12/2024 - 10:00 AM</p>
                    <p><strong>Lugar:</strong> Capilla San José</p>
                </div>
            </div>
        `;
        document.getElementById('detalleParteContent').innerHTML = detalle;
    }, 1000);
    
    $('#modalDetalleParte').modal('show');
}

// Aplicar filtros
function aplicarFiltros() {
    const formData = new FormData(document.getElementById('formFiltros'));
    const params = new URLSearchParams(formData);
    
    // Redirigir según el tipo de reporte
    const tipoReporte = document.getElementById('tipoReporte').value;
    const formato = document.getElementById('formato').value;
    
    let url = '';
    switch(tipoReporte) {
        case 'estado':
            url = "{% url 'custom_admin:reports_estado_partes' %}";
            break;
        case 'urgencia':
            url = "{% url 'custom_admin:reports_urgencia_partes' %}";
            break;
        case 'ingresos':
            url = "{% url 'custom_admin:reports_ingresos_partes' %}";
            break;
    }
    
    url += `?${params.toString()}`;
    
    if (formato === 'html') {
        // Abrir en nueva pestaña
        window.open(url, '_blank');
    } else {
        // Descargar archivo
        window.location.href = url;
    }
    
    $('#modalFiltros').modal('hide');
}

// Exportar reporte
function exportarReporte() {
    const formato = document.getElementById('formato').value;
    const tipoReporte = document.getElementById('tipoReporte').value;
    
    let url = '';
    switch(tipoReporte) {
        case 'estado':
            url = "{% url 'custom_admin:reports_estado_partes' %}";
            break;
        case 'urgencia':
            url = "{% url 'custom_admin:reports_urgencia_partes' %}";
            break;
        case 'ingresos':
            url = "{% url 'custom_admin:reports_ingresos_partes' %}";
            break;
    }
    
    window.location.href = `${url}?formato=${formato}`;
}

// Mostrar/ocultar opciones según tipo de reporte
document.getElementById('tipoReporte').addEventListener('change', function() {
    const tipo = this.value;
    document.getElementById('opcionesUrgencia').style.display = tipo === 'urgencia' ? 'block' : 'none';
    document.getElementById('opcionesIngresos').style.display = tipo === 'ingresos' ? 'block' : 'none';
});

// Verificar que Plotly esté cargado
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Plotly === 'undefined') {
        console.error('Plotly no está cargado. Las gráficas no funcionarán.');
        // Recargar Plotly.js si no está disponible
        const script = document.createElement('script');
        script.src = 'https://cdn.plot.ly/plotly-latest.min.js';
        script.onload = function() {
            console.log('Plotly.js cargado correctamente');
            // Forzar redibujado de gráficas si es necesario
            if (typeof window.Plotly === 'object') {
                window.dispatchEvent(new Event('resize'));
            }
        };
        document.head.appendChild(script);
    } else {
        console.log('Plotly.js está disponible');
    }
});
</script>
{% endblock %}