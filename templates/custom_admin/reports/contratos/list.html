<!-- templates/custom_admin/reports/contratos/list.html -->
{% extends "custom_admin/base_admin.html" %}
{% load static %}

{% block title %}Reportes de Contratos{% endblock %}

{% block extra_css %}
<!-- Incluir Plotly.js desde CDN en el head -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-chart-bar fa-fw"></i> 
                Reportes de Contratos
            </h1>
            <p class="mb-0">Dashboard y reportes de la salud comercial de la empresa</p>
        </div>
      
    </div>

    {% if error %}
    <!-- Alertas de error -->
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong><i class="fas fa-exclamation-triangle fa-fw"></i> Error:</strong> {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Estadísticas principales - ACTUALIZADAS -->
    <div class="row mb-4">
        <!-- Total Contratos -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Contratos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_contratos }}</div>
                            <small class="text-muted">${{ ingresos_totales }}</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-contract fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validados (Activos) -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Validados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ contratos_activos }}</div>
                            <small class="text-muted">${{ ingresos_activos }}</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pendientes (Generados) -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pendientes
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ contratos_pendientes }}</div>
                            <small class="text-muted">Por validar</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Por Vencer -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Por Vencer
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ contratos_por_vencer }}</div>
                            <small class="text-muted">Próximos 30 días</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-hourglass-half fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vencidos -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Vencidos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ contratos_vencidos }}</div>
                            <small class="text-muted">Requieren atención</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancelados -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                Cancelados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ contratos_cancelados }}</div>
                            <small class="text-muted">Contratos anulados</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-ban fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Plotly -->
    <div class="row">
        <!-- Gráfico de Estados (Pastel) -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-pie fa-fw"></i> Contratos por Estado
                    </h6>
                </div>
                <div class="card-body">
                    {% if grafica_pastel_html %}
                        {{ grafica_pastel_html|safe }}
                    {% else %}
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No se pudo generar la gráfica de estados
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Gráfico de Ingresos (Barras) -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-line fa-fw"></i> Ingresos Mensuales
                    </h6>
                </div>
                <div class="card-body">
                    {% if grafica_barras_html %}
                        {{ grafica_barras_html|safe }}
                    {% else %}
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No se pudo generar la gráfica de ingresos
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Contratos Recientes -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list fa-fw"></i> Contratos Recientes
                    </h6>
                    
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Valor</th>
                                    <th>Fecha Generación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contrato in contratos_recientes %}
                                <tr>
                                    <td>
                                        <strong>{{ contrato.numero_contrato }}</strong>
                                    </td>
                                    <td>{{ contrato.nombre_cliente }}</td>
                                    <td>
                                        {% if contrato.estado == 'validado' %}
                                            <span class="badge badge-validado">Validado</span>
                                        {% elif contrato.estado == 'generado' %}
                                            <span class="badge badge-generado">Pendiente</span>
                                        {% elif contrato.estado == 'borrador' %}
                                            <span class="badge badge-borrador">Borrador</span>
                                        {% elif contrato.estado == 'enviado' %}
                                            <span class="badge badge-enviado">Enviado</span>
                                        {% elif contrato.estado == 'firmado' %}
                                            <span class="badge badge-firmado">Firmado</span>
                                        {% elif contrato.estado == 'vencido' %}
                                            <span class="badge badge-vencido">Vencido</span>
                                        {% elif contrato.estado == 'cancelado' %}
                                            <span class="badge badge-cancelado">Cancelado</span>
                                        {% else %}
                                            <span class="badge badge-secondary">{{ contrato.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td>${{ contrato.valor_total }}</td>
                                    <td>{{ contrato.fecha_generacion|date:"d/m/Y" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="verDetalleContrato({{ contrato.id }})">
                                            <i class="fas fa-eye fa-fw"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No hay contratos recientes
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Filtros -->
<div class="modal fade" id="modalFiltros" tabindex="-1" aria-labelledby="modalFiltrosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFiltrosLabel">
                    <i class="fas fa-filter fa-fw"></i> Filtros de Reporte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formFiltros">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                            <input type="date" class="form-control" id="fechaInicio" name="fecha_inicio">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaFin" class="form-label">Fecha Fin</label>
                            <input type="date" class="form-control" id="fechaFin" name="fecha_fin">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipoReporte" class="form-label">Tipo de Reporte</label>
                            <select class="form-select" id="tipoReporte" name="tipo_reporte">
                                <option value="estado">Estado de Contratos</option>
                                <option value="vencimiento">Vencimiento</option>
                                <option value="ingresos">Ingresos</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="formato" class="form-label">Formato de Exportación</label>
                            <select class="form-select" id="formato" name="formato">
                                <option value="html">Vista Web</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" id="opcionesVencimiento" style="display: none;">
                        <div class="col-12 mb-3">
                            <label for="diasAviso" class="form-label">Días para Aviso de Vencimiento</label>
                            <input type="number" class="form-control" id="diasAviso" name="dias_aviso" value="30" min="1" max="365">
                        </div>
                    </div>

                    <div class="row" id="opcionesIngresos" style="display: none;">
                        <div class="col-12 mb-3">
                            <label for="agruparPor" class="form-label">Agrupar Por</label>
                            <select class="form-select" id="agruparPor" name="agrupar_por">
                                <option value="mes">Mes</option>
                                <option value="estado">Estado</option>
                                <option value="cliente">Cliente</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                    <i class="fas fa-check fa-fw"></i> Aplicar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle Contrato -->
<div class="modal fade" id="modalDetalleContrato" tabindex="-1" aria-labelledby="modalDetalleContratoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalleContratoLabel">
                    <i class="fas fa-file-contract fa-fw"></i> Detalle del Contrato
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detalleContratoContent">
                <!-- Contenido cargado via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reporte Completo -->
<div class="modal fade" id="modalReporteCompleto" tabindex="-1" aria-labelledby="modalReporteCompletoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalReporteCompletoLabel">
                    <i class="fas fa-chart-bar fa-fw"></i> Reporte Completo de Contratos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>Estado</th>
                                <th>Cantidad</th>
                                <th>Valor Total</th>
                                <th>Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody id="tablaReporteCompleto">
                            <!-- Cargado via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" onclick="exportarReporteCompleto()">
                    <i class="fas fa-download fa-fw"></i> Exportar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extrajs %}
<script>
// Función para ver detalle de contrato
function verDetalleContrato(contratoId) {
    const contenido = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando detalles del contrato...</p>
        </div>
    `;
    
    document.getElementById('detalleContratoContent').innerHTML = contenido;
    
    // Simular AJAX call
    setTimeout(() => {
        const detalle = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Información del Contrato</h6>
                    <p><strong>Número:</strong> CTR2024120001</p>
                    <p><strong>Cliente:</strong> Empresa Ejemplo S.A.</p>
                    <p><strong>Valor:</strong> $1,500.00</p>
                </div>
                <div class="col-md-6">
                    <h6>Estado y Fechas</h6>
                    <p><strong>Estado:</strong> <span class="badge badge-validado">Validado</span></p>
                    <p><strong>Generado:</strong> 15/12/2024</p>
                    <p><strong>Vence:</strong> 15/01/2025</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Detalles Adicionales</h6>
                    <p>Contrato de publicidad para campaña navideña 2024.</p>
                </div>
            </div>
        `;
        document.getElementById('detalleContratoContent').innerHTML = detalle;
    }, 1000);
    
    $('#modalDetalleContrato').modal('show');
}

// Aplicar filtros
function aplicarFiltros() {
    const formData = new FormData(document.getElementById('formFiltros'));
    const params = new URLSearchParams(formData);
    
    // Redirigir según el tipo de reporte
    const tipoReporte = document.getElementById('tipoReporte').value;
    const formato = document.getElementById('formato').value;
    
    let url = '';
    switch(tipoReporte) {
        case 'estado':
            url = "{% url 'custom_admin:reports_estado_contratos' %}";
            break;
        case 'vencimiento':
            url = "{% url 'custom_admin:reports_vencimiento_contratos' %}";
            break;
        case 'ingresos':
            url = "{% url 'custom_admin:reports_ingresos_contratos' %}";
            break;
    }
    
    url += `?${params.toString()}`;
    
    if (formato === 'html') {
        // Abrir en nueva pestaña
        window.open(url, '_blank');
    } else {
        // Descargar archivo
        window.location.href = url;
    }
    
    $('#modalFiltros').modal('hide');
}

// Exportar reporte
function exportarReporte() {
    const formato = document.getElementById('formato').value;
    const tipoReporte = document.getElementById('tipoReporte').value;
    
    let url = '';
    switch(tipoReporte) {
        case 'estado':
            url = "{% url 'custom_admin:reports_estado_contratos' %}";
            break;
        case 'vencimiento':
            url = "{% url 'custom_admin:reports_vencimiento_contratos' %}";
            break;
        case 'ingresos':
            url = "{% url 'custom_admin:reports_ingresos_contratos' %}";
            break;
    }
    
    window.location.href = `${url}?formato=${formato}`;
}

// Exportar reporte completo
function exportarReporteCompleto() {
    window.location.href = "{% url 'custom_admin:reports_estado_contratos' %}?formato=excel";
}

// Mostrar/ocultar opciones según tipo de reporte
document.getElementById('tipoReporte').addEventListener('change', function() {
    const tipo = this.value;
    document.getElementById('opcionesVencimiento').style.display = tipo === 'vencimiento' ? 'block' : 'none';
    document.getElementById('opcionesIngresos').style.display = tipo === 'ingresos' ? 'block' : 'none';
});

// Verificar que Plotly esté cargado
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Plotly === 'undefined') {
        console.error('Plotly no está cargado. Las gráficas no funcionarán.');
        // Recargar Plotly.js si no está disponible
        const script = document.createElement('script');
        script.src = 'https://cdn.plot.ly/plotly-latest.min.js';
        script.onload = function() {
            console.log('Plotly.js cargado correctamente');
            // Forzar redibujado de gráficas si es necesario
            if (typeof window.Plotly === 'object') {
                window.dispatchEvent(new Event('resize'));
            }
        };
        document.head.appendChild(script);
    } else {
        console.log('Plotly.js está disponible');
    }
});
</script>

<style>
.badge-borrador { background-color: #6c757d; color: white; }
.badge-generado { background-color: #17a2b8; color: white; }
.badge-enviado { background-color: #ffc107; color: black; }
.badge-firmado { background-color: #007bff; color: white; }
.badge-validado { background-color: #28a745; color: white; }
.badge-vencido { background-color: #dc3545; color: white; }
.badge-cancelado { background-color: #343a40; color: white; }

.card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fc;
}

/* Mejoras para los gráficos */
.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.btn-outline-primary:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Responsive */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
}

/* Ajustes para gráficas Plotly */
.plotly-graph-div {
    width: 100% !important;
    min-height: 400px;
}

/* Mejoras visuales para las gráficas */
.js-plotly-plot .plotly .modebar {
    background: transparent !important;
}

.js-plotly-plot .plotly .main-svg {
    border-radius: 8px;
}
</style>
{% endblock %}