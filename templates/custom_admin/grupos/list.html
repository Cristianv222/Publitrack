{% extends 'custom_admin/base_admin.html' %}

{% block title %}Grupos - PublicTrack Admin{% endblock %}

{% block header_title %}Gestión de Grupos y Permisos{% endblock %}

{% block extra_css %}
<style>
    .grupo-card {
        transition: all 0.3s ease;
        border-left: 4px solid var(--accent-color);
        position: relative;
        overflow: hidden;
    }
    .grupo-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .grupo-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, var(--accent-color) 0%, var(--accent-light) 100%);
    }
    .permiso-badge {
        display: inline-block;
        padding: 4px 8px;
        margin: 2px;
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-color);
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .grupo-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    .permisos-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
    }
    .permiso-grupo {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
    }
    .permiso-grupo:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .permiso-grupo-titulo {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
        text-transform: capitalize;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Estadísticas -->
    <div class="col-md-4">
        <div class="stat-card primary">
            <div class="stat-icon">
                <i class="fas fa-users-cog"></i>
            </div>
            <div class="stat-label">Total Grupos</div>
            <div class="stat-value">{{ total_grupos }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card info">
            <div class="stat-icon">
                <i class="fas fa-key"></i>
            </div>
            <div class="stat-label">Permisos Disponibles</div>
            <div class="stat-value">{{ total_permisos }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card success">
            <div class="stat-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-label">Grupos Activos</div>
            <div class="stat-value">{{ total_grupos }}</div>
        </div>
    </div>
</div>

<div class="admin-card">
    <div class="admin-card-header d-flex justify-content-between align-items-center">
        <h5 class="admin-card-title">
            <i class="fas fa-users-cog"></i>
            Grupos del Sistema
        </h5>
        <button class="btn btn-admin-primary" onclick="nuevoGrupo()">
            <i class="fas fa-plus me-2"></i>Nuevo Grupo
        </button>
    </div>
    
    <div class="admin-card-body">
        <div class="row">
            {% for grupo in grupos %}
            <div class="col-lg-6 mb-4">
                <div class="card grupo-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-start mb-3">
                            <div class="grupo-icon me-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="card-title mb-1">{{ grupo.name }}</h5>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-user me-1"></i>
                                    {{ grupo.usuarios_count }} usuario{{ grupo.usuarios_count|pluralize }}
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-key me-1"></i>
                                    {{ grupo.permissions.count }} permiso{{ grupo.permissions.count|pluralize }}
                                </p>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="verUsuariosGrupo({{ grupo.id }}, '{{ grupo.name|escapejs }}')">
                                            <i class="fas fa-users me-2"></i>Ver Usuarios
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="editarGrupo({{ grupo.id }})">
                                            <i class="fas fa-edit me-2"></i>Editar
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" 
                                           onclick="eliminarGrupo({{ grupo.id }}, '{{ grupo.name|escapejs }}')">
                                            <i class="fas fa-trash me-2"></i>Eliminar
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        {% if grupo.permissions.exists %}
                        <div class="mt-3">
                            <small class="text-muted d-block mb-2">Algunos permisos:</small>
                            <div>
                                {% for perm in grupo.permissions.all|slice:":3" %}
                                <span class="permiso-badge">{{ perm.name }}</span>
                                {% endfor %}
                                {% if grupo.permissions.count > 3 %}
                                <span class="permiso-badge">+{{ grupo.permissions.count|add:"-3" }} más</span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="mt-3">
                            <div class="alert alert-warning mb-0">
                                <small><i class="fas fa-exclamation-triangle me-1"></i>Sin permisos asignados</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay grupos registrados.
                    <a href="#" onclick="nuevoGrupo()">Crear el primer grupo</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Grupo -->
<div class="modal fade" id="grupoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="grupoModalTitle">
                    <i class="fas fa-users-cog me-2"></i>Nuevo Grupo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="grupoForm">
                    <input type="hidden" id="grupoId" value="">
                    
                    <div class="mb-3">
                        <label class="form-label">Nombre del Grupo *</label>
                        <input type="text" class="form-control" id="grupoNombre" required
                               placeholder="Ej: Administradores, Vendedores, etc.">
                        <div class="invalid-feedback">El nombre es obligatorio</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Permisos</label>
                        <div class="form-text mb-2">
                            Seleccione los permisos que tendrán los usuarios de este grupo
                        </div>
                        <div class="permisos-container">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAll" 
                                       onchange="toggleAllPermisos()">
                                <label class="form-check-label" for="selectAll">
                                    <strong>Seleccionar todos los permisos</strong>
                                </label>
                            </div>
                            <hr>
                            <div id="permisosLista">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarGrupo()">
                    <i class="fas fa-save me-2"></i>Guardar Grupo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Usuarios del Grupo -->
<div class="modal fade" id="usuariosGrupoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="usuariosGrupoTitle">
                    <i class="fas fa-users me-2"></i>Usuarios del Grupo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="usuariosGrupoContenido">
                <!-- Se llena dinámicamente -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Cargar permisos disponibles
let permisosDisponibles = [];

function cargarPermisos() {
    // Simulación de permisos organizados por app
    // En producción, cargar desde el backend
    const permisosPorApp = {
        'authentication': [
            { id: 1, name: 'Ver usuarios', codename: 'view_user' },
            { id: 2, name: 'Crear usuarios', codename: 'add_user' },
            { id: 3, name: 'Editar usuarios', codename: 'change_user' },
            { id: 4, name: 'Eliminar usuarios', codename: 'delete_user' }
        ],
        'content_management': [
            { id: 5, name: 'Ver cuñas', codename: 'view_cuña' },
            { id: 6, name: 'Crear cuñas', codename: 'add_cuña' },
            { id: 7, name: 'Editar cuñas', codename: 'change_cuña' },
            { id: 8, name: 'Eliminar cuñas', codename: 'delete_cuña' }
        ],
        'financial_management': [
            { id: 9, name: 'Ver facturas', codename: 'view_invoice' },
            { id: 10, name: 'Crear facturas', codename: 'add_invoice' },
            { id: 11, name: 'Editar facturas', codename: 'change_invoice' },
            { id: 12, name: 'Eliminar facturas', codename: 'delete_invoice' }
        ]
    };
    
    let html = '';
    for (const [app, permisos] of Object.entries(permisosPorApp)) {
        html += `<div class="permiso-grupo">`;
        html += `<div class="permiso-grupo-titulo">${app.replace('_', ' ')}</div>`;
        
        permisos.forEach(permiso => {
            html += `
                <div class="form-check">
                    <input class="form-check-input permiso-check" type="checkbox" 
                           value="${permiso.id}" id="perm_${permiso.id}">
                    <label class="form-check-label" for="perm_${permiso.id}">
                        ${permiso.name}
                        <small class="text-muted">(${permiso.codename})</small>
                    </label>
                </div>
            `;
        });
        
        html += `</div>`;
    }
    
    document.getElementById('permisosLista').innerHTML = html;
}

function toggleAllPermisos() {
    const selectAll = document.getElementById('selectAll').checked;
    const checkboxes = document.querySelectorAll('.permiso-check');
    checkboxes.forEach(cb => cb.checked = selectAll);
}

function nuevoGrupo() {
    document.getElementById('grupoModalTitle').innerHTML = '<i class="fas fa-users-cog me-2"></i>Nuevo Grupo';
    document.getElementById('grupoId').value = '';
    document.getElementById('grupoForm').reset();
    document.getElementById('selectAll').checked = false;
    
    cargarPermisos();
    
    new bootstrap.Modal(document.getElementById('grupoModal')).show();
}

function editarGrupo(id) {
    document.getElementById('grupoModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Grupo';
    document.getElementById('grupoId').value = id;
    
    cargarPermisos();
    
    // Cargar datos del grupo
    fetch(`/panel/grupos/api/${id}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('grupoNombre').value = data.data.name;
            
            // Marcar permisos seleccionados
            data.data.permissions.forEach(permId => {
                const checkbox = document.getElementById(`perm_${permId}`);
                if (checkbox) checkbox.checked = true;
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
    
    new bootstrap.Modal(document.getElementById('grupoModal')).show();
}

function guardarGrupo() {
    const form = document.getElementById('grupoForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    
    const id = document.getElementById('grupoId').value;
    
    // Obtener permisos seleccionados
    const permisos = [];
    document.querySelectorAll('.permiso-check:checked').forEach(cb => {
        permisos.push(parseInt(cb.value));
    });
    
    const data = {
        name: document.getElementById('grupoNombre').value,
        permissions: permisos
    };
    
    const url = id ? 
        `/panel/grupos/api/${id}/` : 
        `/panel/grupos/api/crear/`;
    
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: data.message,
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                location.reload();
            });
        } else {
            throw new Error(data.error || 'Error desconocido');
        }
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo guardar el grupo: ' + error.message
        });
    });
}

function verUsuariosGrupo(id, nombre) {
    document.getElementById('usuariosGrupoTitle').innerHTML = 
        `<i class="fas fa-users me-2"></i>Usuarios del Grupo: ${nombre}`;
    
    fetch(`/panel/grupos/api/${id}/usuarios/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            if (data.usuarios.length > 0) {
                html = '<div class="table-responsive">';
                html += '<table class="table table-hover">';
                html += '<thead><tr>';
                html += '<th>Usuario</th>';
                html += '<th>Nombre</th>';
                html += '<th>Email</th>';
                html += '<th>Estado</th>';
                html += '</tr></thead>';
                html += '<tbody>';
                
                data.usuarios.forEach(usuario => {
                    const estado = usuario.is_active ? 
                        '<span class="badge bg-success">Activo</span>' : 
                        '<span class="badge bg-danger">Inactivo</span>';
                    const nombreCompleto = `${usuario.first_name} ${usuario.last_name}`.trim() || '-';
                    
                    html += '<tr>';
                    html += `<td><strong>${usuario.username}</strong></td>`;
                    html += `<td>${nombreCompleto}</td>`;
                    html += `<td>${usuario.email || '-'}</td>`;
                    html += `<td>${estado}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody>';
                html += '</table>';
                html += '</div>';
            } else {
                html = `<div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay usuarios en este grupo
                </div>`;
            }
            
            document.getElementById('usuariosGrupoContenido').innerHTML = html;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
    
    new bootstrap.Modal(document.getElementById('usuariosGrupoModal')).show();
}

function eliminarGrupo(id, nombre) {
    Swal.fire({
        title: '¿Eliminar grupo?',
        html: `¿Está seguro de eliminar el grupo <strong>${nombre}</strong>?<br>
               <small class="text-muted">Esta acción no se puede deshacer</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/panel/grupos/api/${id}/eliminar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Eliminado',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo eliminar el grupo: ' + error.message
                });
            });
        }
    });
}
</script>
{% endblock %}