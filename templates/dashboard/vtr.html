{% extends 'base.html' %}
{% load static %}

{% block title %}Panel Operativo VTR - PublicTrack{% endblock %}

{% block extra_css %}
<style>
    /* Est√©tica de tarjetas Pastel */
    .stat-card {
        border: none;
        border-radius: 15px;
        transition: all 0.3s ease;
        background-color: #fff;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05) !important;
    }

    /* Colores Pastel para bordes y fondos ligeros */
    .border-pastel-blue {
        border-left: 5px solid #a2d2ff !important;
    }

    .border-pastel-green {
        border-left: 5px solid #b9fbc0 !important;
    }

    .border-pastel-yellow {
        border-left: 5px solid #fbf8cc !important;
    }

    .border-pastel-purple {
        border-left: 5px solid #cfbaf0 !important;
    }

    .border-pastel-red {
        border-left: 5px solid #ffcfd2 !important;
    }

    .bg-pastel-blue {
        background-color: #eaf4ff;
    }

    .bg-pastel-green {
        background-color: #f0fff1;
    }

    .bg-pastel-yellow {
        background-color: #fffdf0;
    }

    /* Monitor VTR */
    .monitor-vtr {
        background: #2d3436;
        color: #fab1a0;
        padding: 20px;
        border-radius: 15px;
        font-family: 'Digital-7', 'Courier New', monospace;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .on-air-text {
        color: #ff7675;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
        animation: blink 1.5s infinite;
    }

    @keyframes blink {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.4;
        }

        100% {
            opacity: 1;
        }
    }

    .table-pastel thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        color: #636e72;
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .btn-pastel {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row align-items-center mb-4">
        <div class="col-md-7">
            <h1 class="h3 mb-1 fw-bold text-dark">
                <i class="fas fa-play-circle me-2 text-info"></i>Panel de Control VTR
            </h1>
            <p class="text-muted">Operador: {{ user.get_full_name }} | Estaci√≥n de Trabajo VTR-01</p>
        </div>
        <div class="col-md-5">
            <div class="monitor-vtr d-flex justify-content-between align-items-center">
                <div>
                    <span class="on-air-text"><i class="fas fa-circle me-1"></i> Ready for Air</span>
                </div>
                <div class="text-end">
                    <h2 class="mb-0 fw-bold" id="clock" style="color: #55efc4;">00:00:00</h2>
                    <small class="text-uppercase" style="font-size: 0.7rem; color: #b2bec3;">{{ hoy|date:"D d M Y"
                        }}</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-pastel-blue shadow-sm h-100">
                <div class="card-body">
                    <div class="text-xs fw-bold text-primary text-uppercase mb-1">Tomas Pendientes</div>
                    <div class="h4 mb-0 fw-bold text-gray-800">{{ ordenes_toma.count|default:0 }}</div>
                    <div class="mt-2">
                        <span class="badge bg-pastel-blue text-primary">Esperando validaci√≥n</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-pastel-purple shadow-sm h-100">
                <div class="card-body">
                    <div class="text-xs fw-bold text-purple text-uppercase mb-1" style="color: #6c5ce7;">√ìrdenes
                        Producci√≥n</div>
                    <div class="h4 mb-0 fw-bold text-gray-800">{{ ordenes_produccion.count|default:0 }}</div>
                    <div class="mt-2">
                        <span class="badge" style="background-color: #f3f0ff; color: #6c5ce7;">En proceso</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-pastel-green shadow-sm h-100">
                <div class="card-body">
                    <div class="text-xs fw-bold text-success text-uppercase mb-1">Listos para Emisi√≥n</div>
                    <div class="h4 mb-0 fw-bold text-gray-800">{{ material_listo.count|default:0 }}</div>
                    <div class="mt-2">
                        <span class="badge bg-pastel-green text-success">Validado por VTR</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-pastel-yellow shadow-sm h-100">
                <div class="card-body">
                    <div class="text-xs fw-bold text-warning text-uppercase mb-1">Cu√±as para Hoy</div>
                    <div class="h4 mb-0 fw-bold text-gray-800">{{ cu√±as_hoy.count|default:0 }}</div>
                    <div class="mt-2">
                        <span class="badge bg-pastel-yellow text-warning">Total programado</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0" style="border-radius: 15px;">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-file-import me-2"></i>Tomas Recientes</h6>
                    <button class="btn btn-sm btn-primary btn-pastel" onclick="abrirModalCrearOrden()">
                        <i class="fas fa-plus"></i> Nueva
                    </button>
                </div>
                <div class="table-responsive p-3">
                    <table class="table table-pastel align-middle">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Cliente</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for orden in ordenes_toma_recientes %}
                            <tr>
                                <td><span class="fw-bold">{{ orden.codigo }}</span></td>
                                <td class="small">{{ orden.nombre_cliente }}</td>
                                <td>
                                    <span class="badge bg-pastel-blue text-primary">{{ orden.get_estado_display
                                        }}</span>
                                </td>
                                <td>
                                    <button onclick="verDetalle({{ orden.id }})"
                                        class="btn btn-sm btn-light btn-pastel border">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <button
                                        onclick="abrirModalDescargaOrden({{ orden.id }}, '{{ orden.codigo }}', {{ orden.archivo_orden_firmada|yesno:'true,false' }}, {{ orden.ordenes_generadas.first.id|default:'null' }}, 'toma')"
                                        class="btn btn-sm btn-light btn-pastel border ms-1" title="Descargar">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No hay tomas pendientes</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0" style="border-radius: 15px;">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-file-import me-2"></i>√ìrdenes de Toma</h6>
                </div>
                <div class="table-responsive p-3">
                    <table class="table table-pastel align-middle">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Cliente</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for orden in ordenes_toma|slice:":5" %}
                            <tr>
                                <td><span class="fw-bold">{{ orden.codigo }}</span></td>
                                <td class="small">{{ orden.nombre_cliente }}</td>
                                <td>
                                    <span class="badge bg-pastel-blue text-primary">{{ orden.estado }}</span>
                                </td>
                                <td>
                                    <button onclick="verDetalle({{ orden.id }})"
                                        class="btn btn-sm btn-light btn-pastel border">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <button
                                        onclick="abrirModalDescargaOrden({{ orden.id }}, '{{ orden.codigo }}', {{ orden.archivo_orden_firmada|yesno:'true,false' }}, {{ orden.ordenes_generadas.first.id|default:'null' }}, 'toma')"
                                        class="btn btn-sm btn-light btn-pastel border ms-1" title="Descargar">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No hay tomas pendientes</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0" style="border-radius: 15px;">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-purple"><i class="fas fa-cogs me-2"></i>√ìrdenes de Producci√≥n</h6>
                    <button class="btn btn-sm btn-success btn-pastel" onclick="abrirModalCrearProduccion()">
                        <i class="fas fa-plus"></i> Nueva
                    </button>
                </div>
                <div class="table-responsive p-3">
                    {% if ordenes_produccion %}
                    <table class="table table-pastel align-middle">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>T√≠tulo</th>
                                <th>Estado</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for orden in ordenes_produccion|slice:":5" %}
                            <tr>
                                <td><span class="fw-bold">{{ orden.codigo }}</span></td>
                                <td class="small">{{ orden.titulo_material }}</td>
                                <td>
                                    <span class="badge bg-pastel-green text-success">{{ orden.estado }}</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-light btn-pastel border"
                                        onclick="verDetalleOrdenProduccion({{ orden.id }})" title="Ver Detalles">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light btn-pastel border"
                                        onclick="editarOrdenProduccion({{ orden.id }})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button
                                        onclick="abrirModalDescargaOrden({{ orden.id }}, '{{ orden.codigo }}', {{ orden.archivo_orden_firmada|yesno:'true,false' }}, {{ orden.ordenes_generadas_produccion.first.id|default:'null' }}, 'orden_produccion')"
                                        class="btn btn-sm btn-light btn-pastel border ms-1" title="Descargar">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-film fa-3x text-light mb-3"></i>
                        <p class="text-muted">No hay √≥rdenes de producci√≥n disponibles</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0" style="border-radius: 15px;">
                <div class="card-header bg-white py-3">
                    <h6 class="m-0 fw-bold text-dark"><i class="fas fa-broadcast-tower me-2"></i>Cu√±as Activas en el
                        Sistema para Hoy</h6>
                </div>
                <div class="table-responsive p-3">
                    <table class="table table-hover align-middle" style="font-size: 0.9rem;">
                        <thead class="table-light">
                            <tr>
                                <th>C√≥digo</th>
                                <th>T√≠tulo Comercial</th>
                                <th>Duraci√≥n</th>
                                <th>Repeticiones</th>
                                <th>Estado de Emisi√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cuna in cu√±as_hoy %}
                            <tr>
                                <td><code>{{ cuna.codigo }}</code></td>
                                <td class="fw-bold">{{ cuna.titulo }}</td>
                                <td>{{ cuna.duracion_planeada }} seg.</td>
                                <td>{{ cuna.repeticiones_dia }} veces/d√≠a</td>
                                <td><span class="badge bg-success shadow-sm">Activa</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Cargando datos de emisi√≥n...</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modals from Orders List -->
<!-- Modal Crear/Editar Orden -->
<div class="modal fade" id="modalOrden" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalOrdenTitulo">Nueva Orden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formOrden">
                    {% csrf_token %}
                    <input type="hidden" id="orden_id" name="orden_id">

                    <!-- Informaci√≥n B√°sica -->
                    <h6 class="mb-3 text-primary">Informaci√≥n de la Orden</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Cliente <span class="text-danger">*</span></label>
                            <select class="form-select" name="cliente_id" id="cliente_id" required>
                                <option value="">Seleccionar cliente...</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">
                                    {{ cliente.empresa|default:cliente.get_full_name }} - {{ cliente.ruc_dni }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Prioridad <span class="text-danger">*</span></label>
                            <select class="form-select" name="prioridad" id="prioridad" required>
                                <option value="baja">Baja</option>
                                <option value="normal" selected>Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>

                    <!-- Detalles de Productos/Servicios -->
                    <h6 class="mb-3 text-primary">Detalles de Productos/Servicios</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label class="form-label">Descripci√≥n <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="detalle_productos" id="detalle_productos" rows="3"
                                required placeholder="Describa los productos o servicios solicitados..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Cantidad</label>
                            <input type="number" class="form-control" name="cantidad" id="cantidad" value="1" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total (S/) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="total" id="total" step="0.01" value="0.00"
                                required>
                        </div>
                    </div>

                    <!-- Informaci√≥n Adicional -->
                    <h6 class="mb-3 text-primary">Informaci√≥n Adicional</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label class="form-label">Estado</label>
                            <select class="form-select" name="estado" id="estado">
                                <option value="pendiente" selected>Pendiente</option>
                                <option value="validado">Validado</option>
                                <option value="en_produccion">En Producci√≥n</option>
                                <option value="completado">Completado</option>
                                <option value="no_validado">No Validado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" name="observaciones" id="observaciones" rows="2"
                                placeholder="Observaciones adicionales..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarOrden()">
                    <i class="fas fa-save me-2"></i>Guardar Orden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Orden de Producci√≥n -->
<div class="modal fade" id="modalOrdenProduccion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalOrdenProduccionTitulo">Nueva Orden de Producci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formOrdenProduccion">
                    {% csrf_token %}
                    <input type="hidden" id="orden_produccion_id" name="orden_produccion_id">

                    <h6 class="mb-3 text-primary">Informaci√≥n de la Orden</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Orden de Toma <span class="text-danger">*</span></label>
                            <select class="form-select" name="orden_toma_id" id="orden_toma_id" required>
                                <option value="">Seleccionar orden de toma...</option>
                                {% for toma in ordenes_toma %}
                                <option value="{{ toma.id }}">{{ toma.codigo }} - {{ toma.nombre_cliente }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Producci√≥n <span class="text-danger">*</span></label>
                            <select class="form-select" name="tipo_produccion" id="tipo_produccion" required>
                                <option value="video">Video</option>
                                <option value="audio">Audio</option>
                                <option value="diseno">Dise√±o</option>
                                <option value="animacion">Animaci√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Prioridad <span class="text-danger">*</span></label>
                            <select class="form-select" name="prioridad" id="prioridad_prod" required>
                                <option value="baja">Baja</option>
                                <option value="normal" selected>Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <!-- Productor Asignado hardcoded to current user or simplified as BTR is often the authorized -->
                            <label class="form-label">Productor Asignado</label>
                            <input type="text" class="form-control" value="{{ user.get_full_name }}" disabled>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarOrdenProduccion()">
                    <i class="fas fa-save me-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Opciones Descarga -->
<div class="modal fade" id="modalOpcionesDescarga" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>Descargar Orden
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <h6 class="text-muted mb-1">Seleccione una opci√≥n para la orden:</h6>
                    <h4 id="descargaOrdenCodigo" class="fw-bold text-primary"></h4>
                </div>

                <div class="d-grid gap-3">
                    <button class="btn btn-outline-primary btn-lg p-3 text-start d-flex align-items-center"
                        onclick="procederDescargaSistema()">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="fas fa-file-contract fa-2x text-primary"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Versi√≥n del Sistema</div>
                            <small class="text-muted">Generada autom√°ticamente a partir de los datos</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                    </button>

                    <button id="btnDescargaValidada"
                        class="btn btn-outline-success btn-lg p-3 text-start d-flex align-items-center"
                        onclick="procederDescargaValidado()">
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="fas fa-file-signature fa-2x text-success"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Versi√≥n Validada</div>
                            <small class="text-muted">Documento firmado subido por el usuario</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                    </button>

                    <div id="msgNoValidada" class="text-center text-muted small mt-2" style="display:none;">
                        <i class="fas fa-info-circle me-1"></i> No hay versi√≥n validada disponible
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Seleccionar Plantilla -->
<div class="modal fade" id="modalSeleccionarPlantilla" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Seleccionar Plantilla
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <h6 class="text-muted mb-1">Seleccione una plantilla para la orden:</h6>
                    <h5 id="plantillaOrdenCodigo" class="fw-bold text-primary"></h5>
                </div>

                <div class="mb-4">
                    <label for="plantillaOrden" class="form-label">Plantilla:</label>
                    <select class="form-select" id="plantillaOrden">
                        <option value="">Cargando plantillas...</option>
                    </select>
                    <small class="text-muted">
                        Seleccione la plantilla que desea utilizar para generar el PDF
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="generarOrdenConPlantilla()">
                    <i class="fas fa-file-pdf me-2"></i>Generar PDF
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Reloj Digital para Operaciones VTR
    function updateVTRClock() {
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ':' +
            now.getMinutes().toString().padStart(2, '0') + ':' +
            now.getSeconds().toString().padStart(2, '0');
        const clockEl = document.getElementById('clock');
        if (clockEl) clockEl.textContent = time;
    }
    setInterval(updateVTRClock, 1000);
    updateVTRClock();

    let modalOrden, modalOrdenProduccion;
    // Variables para descarga
    let modalOpcionesDescarga;
    let modalSeleccionarPlantilla;
    let ordenDescargaActual = null;
    let ordenGeneradaActualId = null;
    let ordenDescargaTipo = 'toma'; // 'toma' o 'orden_produccion'

    document.addEventListener('DOMContentLoaded', function () {
        modalOrden = new bootstrap.Modal(document.getElementById('modalOrden'));
        modalOrdenProduccion = new bootstrap.Modal(document.getElementById('modalOrdenProduccion'));
        // Inicializar modales de descarga
        modalOpcionesDescarga = new bootstrap.Modal(document.getElementById('modalOpcionesDescarga'));
        modalSeleccionarPlantilla = new bootstrap.Modal(document.getElementById('modalSeleccionarPlantilla'));
    });

    // --- Ordenes Toma Functions ---
    function abrirModalCrearOrden() {
        document.getElementById('modalOrdenTitulo').textContent = 'Nueva Orden';
        document.getElementById('formOrden').reset();
        document.getElementById('orden_id').value = '';
        modalOrden.show();
    }

    function editarOrden(orderId) {
        document.getElementById('modalOrdenTitulo').textContent = 'Editar Orden';
        document.getElementById('orden_id').value = orderId;

        fetch(`/panel/orders/${orderId}/detalle/`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const orden = data.orden;
                    document.getElementById('cliente_id').value = orden.cliente_id || '';
                    document.getElementById('prioridad').value = orden.prioridad;
                    document.getElementById('detalle_productos').value = orden.detalle_productos;
                    document.getElementById('cantidad').value = orden.cantidad;
                    document.getElementById('total').value = orden.total;
                    document.getElementById('estado').value = orden.estado;
                    document.getElementById('observaciones').value = orden.observaciones;
                    modalOrden.show();
                }
            });
    }

    function guardarOrden() {
        console.log('üîµ guardarOrden() llamada');
        const ordenId = document.getElementById('orden_id').value;
        const form = document.getElementById('formOrden');

        if (!form.checkValidity()) {
            console.log('‚ùå Formulario inv√°lido');
            form.reportValidity();
            return;
        }

        const formData = {
            cliente_id: document.getElementById('cliente_id').value,
            detalle_productos: document.getElementById('detalle_productos').value,
            cantidad: document.getElementById('cantidad').value,
            total: document.getElementById('total').value,
            prioridad: document.getElementById('prioridad').value,
            estado: document.getElementById('estado').value,
            observaciones: document.getElementById('observaciones').value,
        };

        console.log('üì¶ Datos a enviar:', formData);

        const url = ordenId ? `/panel/orders/${ordenId}/editar/` : '/panel/orders/crear/';
        const method = ordenId ? 'PUT' : 'POST';

        console.log(`üåê Enviando ${method} a ${url}`);

        modalOrden.hide();

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
            .then(res => {
                console.log('üì° Respuesta recibida:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('üì• Data:', data);
                if (data.success) {
                    alert('‚úÖ Orden guardada exitosamente');
                    location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Error al guardar'));
                    modalOrden.show();
                }
            })
            .catch(error => {
                console.error('üí• Error en fetch:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message);
                modalOrden.show();
            });
    }

    function verDetalle(id) {
        console.log('üîç Ver detalle orden:', id);
        // Por ahora, redirigir a la p√°gina de detalle
        window.location.href = `/panel/orders/${id}/detalle/`;
    }

    // --- Ordenes Produccion Functions ---
    function abrirModalCrearProduccion() {
        console.log('üé¨ Abriendo modal crear producci√≥n');
        document.getElementById('modalOrdenProduccionTitulo').textContent = 'Nueva Orden de Producci√≥n';
        document.getElementById('formOrdenProduccion').reset();
        document.getElementById('orden_produccion_id').value = '';
        modalOrdenProduccion.show();
    }

    function editarOrdenProduccion(id) {
        console.log('‚úèÔ∏è Editando orden producci√≥n:', id);
        document.getElementById('modalOrdenProduccionTitulo').textContent = 'Editar Orden de Producci√≥n';
        document.getElementById('orden_produccion_id').value = id;

        fetch(`/panel/ordenes-produccion/${id}/detalle/`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const orden = data.orden;
                    // Populate fields
                    if (document.getElementById('orden_toma_id'))
                        document.getElementById('orden_toma_id').value = orden.orden_toma_id || '';
                    document.getElementById('tipo_produccion').value = orden.tipo_produccion;
                    document.getElementById('prioridad_prod').value = orden.prioridad;
                    modalOrdenProduccion.show();
                } else {
                    console.error('Error cargando orden:', data.error);
                    alert('Error al cargar la orden: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                alert('Error de conexi√≥n: ' + error.message);
            });
    }

    function guardarOrdenProduccion() {
        console.log('üîµ guardarOrdenProduccion() llamada');
        const id = document.getElementById('orden_produccion_id').value;
        const formData = {
            orden_toma_id: document.getElementById('orden_toma_id').value,
            tipo_produccion: document.getElementById('tipo_produccion').value,
            prioridad: document.getElementById('prioridad_prod').value
        };

        console.log('üì¶ Datos a enviar:', formData);

        const url = id ? `/panel/ordenes-produccion/${id}/editar/` : '/panel/ordenes-produccion/crear/';
        const method = id ? 'PUT' : 'POST';

        console.log(`üåê Enviando ${method} a ${url}`);

        modalOrdenProduccion.hide();

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
            .then(res => {
                console.log('üì° Respuesta recibida:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('üì• Data:', data);
                if (data.success) {
                    alert('‚úÖ Orden de producci√≥n guardada exitosamente');
                    location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Error al guardar'));
                    modalOrdenProduccion.show();
                }
            })
            .catch(error => {
                console.error('üí• Error en fetch:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message);
                modalOrdenProduccion.show();
            });
    }

</script>

<!-- Modal Detalle Orden Producci√≥n -->
<div class="modal fade" id="modalDetalleOrdenProduccion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles de la Orden de Producci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2">Informaci√≥n B√°sica</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">C√≥digo:</label>
                        <span id="det_prod_codigo" class="fs-5"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">Orden de Toma:</label>
                        <span id="det_prod_orden_toma"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2">Informaci√≥n del Cliente</h6>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">Nombre:</label>
                        <span id="det_prod_cliente_nombre"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">RUC/DNI:</label>
                        <span id="det_prod_cliente_ruc"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">Empresa:</label>
                        <span id="det_prod_cliente_empresa"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2">Detalles de la Producci√≥n</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">Proyecto/Campa√±a:</label>
                        <span id="det_prod_proyecto"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">T√≠tulo del Material:</label>
                        <span id="det_prod_titulo"></span>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="fw-bold small text-muted d-block">Descripci√≥n Breve:</label>
                        <p id="det_prod_descripcion" class="text-muted fst-italic bg-light p-2 rounded"></p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">Tipo de Producci√≥n:</label>
                        <span id="det_prod_tipo" class="badge bg-secondary"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">Prioridad:</label>
                        <span id="det_prod_prioridad"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2">Fechas</h6>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="fw-bold small text-muted d-block">Inicio Planeado:</label>
                        <span id="det_prod_inicio_plan"></span>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="fw-bold small text-muted d-block">Fin Planeado:</label>
                        <span id="det_prod_fin_plan"></span>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="fw-bold small text-muted d-block">Inicio Real:</label>
                        <span id="det_prod_inicio_real"></span>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="fw-bold small text-muted d-block">Fin Real:</label>
                        <span id="det_prod_fin_real"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2">Recursos y Equipo</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">Equipo Asignado:</label>
                        <span id="det_prod_equipo"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">Recursos Necesarios:</label>
                        <span id="det_prod_recursos"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">Productor Asignado:</label>
                        <span id="det_prod_productor"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2">Especificaciones</h6>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">Especificaciones T√©cnicas:</label>
                        <span id="det_prod_especificaciones"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold small text-muted d-block">Archivos Entregables:</label>
                        <span id="det_prod_entregables"></span>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="fw-bold small text-muted d-block">Observaciones:</label>
                        <p id="det_prod_observaciones" class="text-muted small"></p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary border-bottom pb-2">Estado</h6>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">Estado:</label>
                        <span id="det_prod_estado" class="badge"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">D√≠as de Retraso:</label>
                        <span id="det_prod_retraso"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="fw-bold small text-muted d-block">Fecha de Creaci√≥n:</label>
                        <span id="det_prod_creacion"></span>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variable global para el modal de detalle
    let modalDetalleOrdenProduccion;

    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar modal
        modalDetalleOrdenProduccion = new bootstrap.Modal(document.getElementById('modalDetalleOrdenProduccion'));
    });

    function verDetalleOrdenProduccion(id) {
        console.log('üîç Ver detalle orden producci√≥n:', id);

        fetch(`/panel/ordenes-produccion/${id}/detalle/`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const orden = data.orden;

                    // Helper para valores nulos
                    const val = (v, def = 'N/A') => (v === null || v === undefined || v === '') ? def : v;

                    // Llenar campos
                    document.getElementById('det_prod_codigo').textContent = val(orden.codigo);
                    document.getElementById('det_prod_orden_toma').textContent = orden.orden_toma_codigo ? `${orden.orden_toma_codigo}` : 'N/A';

                    document.getElementById('det_prod_cliente_nombre').textContent = val(orden.nombre_cliente);
                    document.getElementById('det_prod_cliente_ruc').textContent = val(orden.ruc_dni_cliente);
                    document.getElementById('det_prod_cliente_empresa').textContent = val(orden.empresa_cliente);

                    document.getElementById('det_prod_proyecto').textContent = val(orden.proyecto_campania);
                    document.getElementById('det_prod_titulo').textContent = val(orden.titulo_material);
                    document.getElementById('det_prod_descripcion').textContent = val(orden.descripcion_breve);

                    document.getElementById('det_prod_tipo').textContent = val(orden.tipo_produccion).toUpperCase();
                    document.getElementById('det_prod_prioridad').textContent = val(orden.prioridad).toUpperCase();

                    document.getElementById('det_prod_inicio_plan').textContent = val(orden.fecha_inicio_planeada, 'No definido');
                    document.getElementById('det_prod_fin_plan').textContent = val(orden.fecha_fin_planeada, 'No definido');
                    document.getElementById('det_prod_inicio_real').textContent = val(orden.fecha_inicio_real, 'No iniciado');
                    document.getElementById('det_prod_fin_real').textContent = val(orden.fecha_fin_real, 'No completado');

                    document.getElementById('det_prod_equipo').textContent = val(orden.equipo_asignado, 'No definido');
                    document.getElementById('det_prod_recursos').textContent = val(orden.recursos_necesarios, 'No definido');
                    document.getElementById('det_prod_productor').textContent = val(orden.productor_asignado_nombre, 'Sin asignar');

                    document.getElementById('det_prod_especificaciones').textContent = val(orden.especificaciones_tecnicas, 'No definido');
                    document.getElementById('det_prod_entregables').textContent = val(orden.archivos_entregables, 'No definido');
                    document.getElementById('det_prod_observaciones').textContent = val(orden.observaciones_produccion, 'Ninguna');

                    const estadoEl = document.getElementById('det_prod_estado');
                    estadoEl.textContent = val(orden.estado).toUpperCase();
                    estadoEl.className = 'badge ' + getEstadoBadgeClass(orden.estado);

                    const retrasoEl = document.getElementById('det_prod_retraso');
                    if (orden.dias_retraso > 0) {
                        retrasoEl.innerHTML = `<span class="text-danger fw-bold">${orden.dias_retraso} d√≠as</span>`;
                    } else if (orden.dias_retraso < 0) {
                        retrasoEl.innerHTML = `<span class="text-success fw-bold">${Math.abs(orden.dias_retraso)} d√≠as antelaci√≥n</span>`;
                    } else {
                        retrasoEl.textContent = 'A tiempo';
                    }

                    document.getElementById('det_prod_creacion').textContent = val(orden.fecha_creacion);

                    modalDetalleOrdenProduccion.show();
                } else {
                    alert('Error al cargar detalles: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error de conexi√≥n al cargar detalles');
            });
    }

    function getEstadoBadgeClass(estado) {
        switch (estado) {
            case 'pendiente': return 'bg-warning text-dark';
            case 'en_produccion': return 'bg-info text-white';
            case 'en_revision': return 'bg-primary';
            case 'aprobado': return 'bg-success';
            case 'rechazado': return 'bg-danger';
            case 'pausado': return 'bg-secondary';
            default: return 'bg-light text-dark border';
        }
    }

    // --- Download Functions ---
    function abrirModalDescargaOrden(ordenId, codigo, tieneValidado, ordenGeneradaId, tipo = 'toma') {
        ordenDescargaActual = ordenId;
        ordenGeneradaActualId = ordenGeneradaId;
        ordenDescargaTipo = tipo;
        document.getElementById('descargaOrdenCodigo').textContent = codigo;

        const btnValidada = document.getElementById('btnDescargaValidada');
        const msgNoValidada = document.getElementById('msgNoValidada');

        if (tieneValidado) {
            btnValidada.disabled = false;
            btnValidada.classList.remove('opacity-50');
            msgNoValidada.style.display = 'none';
        } else {
            btnValidada.disabled = true;
            btnValidada.classList.add('opacity-50');
            msgNoValidada.style.display = 'block';
        }

        modalOpcionesDescarga.show();
    }

    function procederDescargaSistema() {
        if (ordenDescargaActual) {
            modalOpcionesDescarga.hide();
            // Peque√±o timeout para permitir que el modal se cierre visualmente antes de abrir el siguiente
            // y evitar conflictos de foco/aria-hidden
            setTimeout(() => {
                cargarPlantillasYMostrarModal();
            }, 300);
        }
    }

    function procederDescargaValidado() {
        if (ordenDescargaActual) {
            let url = '';
            if (ordenDescargaTipo === 'orden_produccion') {
                url = `/panel/ordenes-produccion/${ordenDescargaActual}/descargar-validado/`;
            } else {
                url = `/panel/orders/${ordenDescargaActual}/descargar-validado/`;
            }
            window.open(url, '_blank');
            modalOpcionesDescarga.hide();
        }
    }

    function cargarPlantillasYMostrarModal() {
        const select = document.getElementById('plantillaOrden');
        select.innerHTML = '<option value="">Cargando...</option>';
        document.getElementById('plantillaOrdenCodigo').textContent = document.getElementById('descargaOrdenCodigo').textContent;

        modalSeleccionarPlantilla.show();

        let url = '';
        if (ordenDescargaTipo === 'orden_produccion') {
            url = `/panel/ordenes-produccion/${ordenDescargaActual}/plantillas/`;
        } else {
            url = `/panel/orders/${ordenDescargaActual}/plantillas/`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    select.innerHTML = '';
                    if (data.plantillas.length === 0) {
                        select.innerHTML = '<option value="">No hay plantillas disponibles</option>';
                    } else {
                        data.plantillas.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.id;
                            option.text = p.nombre + (p.is_default ? ' (Por defecto)' : '');
                            if (p.is_default) option.selected = true;
                            select.appendChild(option);
                        });
                    }
                } else {
                    select.innerHTML = '<option value="">Error al cargar</option>';
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                select.innerHTML = '<option value="">Error de conexi√≥n</option>';
            });
    }

    function generarOrdenConPlantilla() {
        console.log('Iniciando generaci√≥n de PDF...');
        const plantillaId = document.getElementById('plantillaOrden').value;
        if (!plantillaId) {
            alert('Por favor seleccione una plantilla');
            return;
        }

        modalSeleccionarPlantilla.hide();

        Swal.fire({
            title: 'Generando PDF...',
            html: 'Por favor espere mientras se genera el documento.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Get CSRF token safely
        const csrfTokenEl = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfTokenEl) {
            console.error('CSRF Token no encontrado');
            Swal.fire('Error', 'Token de seguridad no encontrado', 'error');
            return;
        }

        let url = '';
        if (ordenDescargaTipo === 'orden_produccion') {
            url = `/panel/ordenes-produccion/${ordenDescargaActual}/generar/`;
        } else {
            url = `/panel/orders/${ordenDescargaActual}/generar/`;
        }

        console.log('Solicitando generaci√≥n a:', url);

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfTokenEl.value
            },
            body: JSON.stringify({
                plantilla_id: plantillaId
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en el servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta generaci√≥n:', data);
                if (data.success) {
                    Swal.close();
                    if (data.archivo_url) {
                        try {
                            // Usar un enlace temporal para evitar bloqueo de popups
                            const link = document.createElement('a');
                            link.href = data.archivo_url;
                            link.target = '_blank';
                            // Intentar forzar descarga con nombre de archivo si es posible
                            if (data.numero_orden) {
                                link.download = `Orden_${data.numero_orden}.pdf`;
                            }
                            document.body.appendChild(link);
                            link.click();
                            setTimeout(() => {
                                document.body.removeChild(link);
                            }, 100);
                        } catch (e) {
                            console.error('Error al intentar abrir el enlace:', e);
                            // Fallback
                            window.open(data.archivo_url, '_blank');
                        }
                    } else {
                        Swal.fire('Atenci√≥n', 'El PDF se gener√≥ pero no se recibi√≥ la URL de descarga.', 'warning');
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Error al generar el PDF'
                    });
                }
            })
            .catch(error => {
                console.error('Error en generarOrdenConPlantilla:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error de conexi√≥n o del servidor al generar el PDF. Revise la consola para m√°s detalles.'
                });
            });
    }
</script>
{% endblock %}